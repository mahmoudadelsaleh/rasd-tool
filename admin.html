<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù‚Ø§Ø¦Ø¯ v2026 - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø¹ØªÙ…Ø¯</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --bg: #f8fafc; --sidebar: #1e293b; --accent: #3b82f6; --c-exp: #10b981; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        header { background: var(--sidebar); color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        .tabs-nav { display: flex; background: white; padding: 5px; gap: 5px; overflow-x: auto; border-bottom: 1px solid #e2e8f0; }
        .tab-btn { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; white-space: nowrap; background: #f1f5f9; color: #64748b; }
        .tab-btn.active { background: var(--accent); color: white; }
        .content-area { flex: 1; overflow-y: auto; padding: 20px; }
        .tab-panel { display: none; max-width: 1000px; margin: auto; animation: fadeIn 0.3s ease; }
        .tab-panel.active { display: block; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        input, select, textarea { width: 100%; padding: 10px; margin: 8px 0; border-radius: 8px; border: 1px solid #cbd5e1; }
        .btn-main { background: var(--sidebar); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { background: #f1f5f9; padding: 10px; text-align: right; font-size: 13px; }
        td { padding: 10px; border-bottom: 1px solid #eee; font-size: 14px; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<header>
    <div>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© | <b>2026</b></div>
    <div id="status" style="font-size: 12px; color: #94a3b8;">Ù…ØªØµÙ„ âœ…</div>
</header>

<div class="tabs-nav">
    <button class="tab-btn active" onclick="openTab(event, 'stats')">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
    <button class="tab-btn" onclick="openTab(event, 'teachers')">ğŸ‘¨â€ğŸ« Ø§Ù„Ù…Ø¹Ù„Ù…ÙˆÙ†</button>
    <button class="tab-btn" onclick="openTab(event, 'students')">ğŸ“ Ø§Ù„Ø·Ù„Ø§Ø¨</button>
    <button class="tab-btn" onclick="openTab(event, 'export')">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
</div>

<div class="content-area">
    <div id="stats" class="tab-panel active">
        <div class="card">
            <h2>Ù…Ù„Ø®Øµ Ø§Ù„Ù†Ø¸Ø§Ù…</h2>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div style="text-align:center; padding:20px; background:#eff6ff; border-radius:10px;">Ù…Ø¹Ù„Ù…ÙˆÙ†<br><b id="countT" style="font-size:24px;">0</b></div>
                <div style="text-align:center; padding:20px; background:#ecfdf5; border-radius:10px;">Ø·Ù„Ø§Ø¨<br><b id="countS" style="font-size:24px;">0</b></div>
            </div>
        </div>
    </div>

    <div id="teachers" class="tab-panel">
        <div class="card">
            <h3>Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹Ù„Ù…</h3>
            <input type="text" id="tName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…">
            <input type="text" id="tSub" placeholder="Ø§Ù„Ù…Ø§Ø¯Ø©">
            <input type="text" id="tUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„)">
            <input type="password" id="tPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <div style="font-size:12px; margin-top:10px;">Ø§Ù„ÙØµÙˆÙ„ (Ù…Ø«Ø§Ù„: 1_general, 2_scientific):</div>
            <input type="text" id="tClasses" placeholder="ÙØµÙ„1, ÙØµÙ„2">
            <button class="btn-main" onclick="saveTeacher()">Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…</button>
        </div>
        <div class="card">
            <table id="tTable"><thead><tr><th>Ø§Ù„Ù…Ø¹Ù„Ù…</th><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„ÙØµÙˆÙ„</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody id="tBody"></tbody></table>
        </div>
    </div>

    <div id="students" class="tab-panel">
        <div class="card">
            <h3>Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
            <select id="sGrade">
                <option value="1_general">1 Ø«Ø§Ù†ÙˆÙŠ</option>
                <option value="2_scientific">2 Ø«Ø§Ù†ÙˆÙŠ Ø¹Ù„Ù…ÙŠ</option>
                <option value="2_literary">2 Ø«Ø§Ù†ÙˆÙŠ Ø£Ø¯Ø¨ÙŠ</option>
            </select>
            <textarea id="sNames" rows="5" placeholder="Ø¶Ø¹ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ù‡Ù†Ø§ (Ø§Ø³Ù… ÙÙŠ ÙƒÙ„ Ø³Ø·Ø±)"></textarea>
            <button class="btn-main" onclick="uploadStudents()">Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨</button>
        </div>
    </div>

    <div id="export" class="tab-panel">
        <div class="card" style="border-right: 5px solid var(--c-exp);">
            <h2>ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø§Ù„Ù…Ø¬Ù…Ø¹Ø©</h2>
            <p style="font-size:13px; color:#64748b;">Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙŠØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø§Ù„Ø£ÙˆØ²Ø§Ù† Ø§Ù„Ù†Ø³Ø¨ÙŠØ© (70 Ø¯Ø±Ø¬Ø©) Ù…Ø¹ Ù…Ø±Ø§Ø¹Ø§Ø© Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø§Ù„ØªÙŠ Ø­Ø¯Ø¯Ù‡Ø§ Ø§Ù„Ù…Ø¹Ù„Ù…ÙˆÙ† Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª.</p>
            <select id="expGrade">
                <option value="1_general">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ</option>
                <option value="2_scientific">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø«Ø§Ù†ÙˆÙŠ Ø¹Ù„Ù…ÙŠ</option>
                <option value="2_literary">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø«Ø§Ù†ÙˆÙŠ Ø£Ø¯Ø¨ÙŠ</option>
            </select>
            <button class="btn-main" style="background:var(--c-exp)" onclick="exportComprehensiveExcel()">ØªØµØ¯ÙŠØ± Ù…Ù„Ù Excel Ø§Ù„Ù…Ø¬Ù…Ø¹</button>
            <div id="expStatus" style="margin-top:15px; font-weight:bold;"></div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyBePGZiqMPmZQdg36jZ4Rkdtd7OISxmob8", projectId: "rasd-tools" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let teachers = [], students = [];

    function openTab(evt, tabId) {
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        evt.currentTarget.classList.add('active');
    }

    async function loadData() {
        const tSnap = await db.collection('teachers').get();
        teachers = tSnap.docs.map(doc => ({id: doc.id, ...doc.data()}));
        const sSnap = await db.collection('students').get();
        students = sSnap.docs.map(doc => ({id: doc.id, ...doc.data()}));
        
        document.getElementById('countT').innerText = teachers.length;
        document.getElementById('countS').innerText = students.length;
        renderTeachers();
    }

    function renderTeachers() {
        const b = document.getElementById('tBody'); b.innerHTML = '';
        teachers.forEach(t => {
            b.innerHTML += `<tr><td>${t.name}</td><td>${t.subject}</td><td>${t.classes?.join(',')}</td>
            <td><button onclick="deleteT('${t.id}')" style="color:red">Ø­Ø°Ù</button></td></tr>`;
        });
    }

    async function saveTeacher() {
        const id = document.getElementById('tUser').value;
        const data = {
            name: document.getElementById('tName').value,
            subject: document.getElementById('tSub').value,
            pass: document.getElementById('tPass').value,
            classes: document.getElementById('tClasses').value.split(',').map(c => c.trim())
        };
        await db.collection('teachers').doc(id).set(data, {merge:true});
        alert("ØªÙ… Ø§Ù„Ø­ÙØ¸"); loadData();
    }

    async function uploadStudents() {
        const names = document.getElementById('sNames').value.split('\n').filter(n => n.trim());
        const grade = document.getElementById('sGrade').value;
        const [g, b] = grade.split('_');
        const batch = db.batch();
        names.forEach(n => {
            const ref = db.collection('students').doc();
            batch.set(ref, {name: n.trim(), grade: g, branch: b, sortOrder: Date.now()});
        });
        await batch.commit();
        alert("ØªÙ… Ø§Ù„Ø±ÙØ¹"); loadData();
    }

    // --- Ø¯Ø§Ù„Ø© Ø§Ù„ØªØµØ¯ÙŠØ± Ø§Ù„Ø¹Ø¨Ù‚Ø±ÙŠØ© ---
    async function exportComprehensiveExcel() {
        const gradeVal = document.getElementById('expGrade').value;
        const status = document.getElementById('expStatus');
        status.innerText = "â³ Ø¬Ø§Ø±ÙŠ ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ­Ù„ÙŠÙ„ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†...";
        
        try {
            const [g, b] = gradeVal.split('_');
            const targetStudents = students.filter(s => s.grade === g && s.branch === b).sort((a,b)=>a.sortOrder - b.sortOrder);
            const gSnap = await db.collection('grades').get();
            const allGrades = gSnap.docs.map(d => d.data());
            
            const wb = XLSX.utils.book_new();
            const relevantTeachers = teachers.filter(t => t.classes.includes(gradeVal));
            const subjects = [...new Set(relevantTeachers.map(t => t.subject))];

            subjects.forEach(sub => {
                const subTeachers = relevantTeachers.filter(t => t.subject === sub);
                const tIds = subTeachers.map(t => t.id);

                const sheetData = targetStudents.map(student => {
                    const sGrades = allGrades.filter(rg => rg.sid === student.id && tIds.includes(rg.teacher));
                    
                    // Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø£ÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø¯Ø© (Ù„Ø£Ø®Ø° Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…Ù†Ù‡)
                    const mainT = subTeachers[0];
                    const ex1W = mainT.exam1Week || "w6";
                    const ex2W = mainT.exam2Week || "w10";

                    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØªÙˆØ³Ø·Ø§Øª (Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø§Ù„ØªÙŠ Ø§Ø®ØªØ§Ø±Ù‡Ø§ Ø§Ù„Ù…Ø¹Ù„Ù… ÙƒØ£ÙŠØ§Ù… Ø§Ø®ØªØ¨Ø§Ø±)
                    const calcAvg = (type) => {
                        const vals = sGrades.filter(v => v.type === type && v.week !== ex1W && v.week !== ex2W && !v.week.startsWith('ex'))
                                           .map(v => v.score);
                        return vals.length ? parseFloat((vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(2)) : 0;
                    };

                    // Ø¬Ù„Ø¨ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø®ØµØµØ©
                    const getExamScore = (exKey) => {
                        const entry = sGrades.find(v => v.week === exKey && v.type === 'exam');
                        if(!entry) return 0;
                        let s = parseFloat(entry.score) || 0;
                        return (entry.maxSet === 15) ? s * 2 : s; // Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ù†Ø³Ø¨ÙŠ
                    };

                    const ex1Score = getExamScore('ex1');
                    const ex2Score = getExamScore('ex2');
                    const avgExams = parseFloat(((ex1Score + ex2Score) / 2).toFixed(2));

                    const avgT = calcAvg('t');
                    const avgV = calcAvg('v');
                    const avgS = calcAvg('s');

                    return {
                        "Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨": student.name,
                        "Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª (15)": avgT,
                        "Ø§Ù„Ø­ØµØ© ÙˆØ§Ù„ÙˆØ§Ø¬Ø¨ (15)": avgV,
                        "Ø§Ù„Ø³Ù„ÙˆÙƒ (10)": avgS,
                        "Ù…ØªÙˆØ³Ø· Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª (30)": avgExams,
                        "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (70)": parseFloat((avgT + avgV + avgS + avgExams).toFixed(2))
                    };
                });

                const ws = XLSX.utils.json_to_sheet(sheetData);
                XLSX.utils.book_append_sheet(wb, ws, sub);
            });

            XLSX.writeFile(wb, `Ø§Ù„Ù†ØªØ§Ø¦Ø¬_Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©_${gradeVal}.xlsx`);
            status.innerText = "âœ… ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­!";
        } catch (e) {
            status.innerText = "âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±: " + e.message;
            console.error(e);
        }
    }

    window.onload = loadData;
</script>
</body>
</html>
