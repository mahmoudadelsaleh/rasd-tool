<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø´Ø§Ù…Ù„Ø© - Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --sidebar: #0f172a; --accent: #3b82f6; --danger: #ef4444; --success: #22c55e; --bg: #f1f5f9; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; }
        
        header { background: var(--sidebar); color: white; padding: 15px; text-align: center; }
        
        /* Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù…Ø¯Ù…Ø¬ */
        .tabs { display: flex; background: white; overflow-x: auto; border-bottom: 1px solid #e2e8f0; sticky: top; z-index: 100; }
        .tab-btn { padding: 15px 20px; border: none; background: none; cursor: pointer; font-weight: bold; color: #64748b; white-space: nowrap; }
        .tab-btn.active { color: var(--accent); border-bottom: 3px solid var(--accent); background: #eff6ff; }
        
        .container { padding: 20px; max-width: 1100px; margin: auto; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        
        .card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        
        /* Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
        th, td { padding: 12px; text-align: right; border-bottom: 1px solid #e2e8f0; }
        th { background: #f8fafc; color: #1e293b; }
        
        /* Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© (Ø§Ù„ÙØµÙˆÙ„ ÙˆØ§Ù„Ø·Ù„Ø§Ø¨) */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        input, select, textarea { width: 100%; padding: 10px; margin: 5px 0 15px; border-radius: 8px; border: 1px solid #cbd5e1; box-sizing: border-box; }
        .btn { padding: 10px 15px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        
        /* Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ */
        .status-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        .toggle-box { padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; text-align: center; background: #fff; }
        .badge { padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; }
        .badge-open { background: #dcfce7; color: #166534; }
        .badge-closed { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>

<header>
    <h2>Ù†Ø¸Ø§Ù… Ø§Ù„Ø±ØµØ¯ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ - Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</h2>
</header>

<div class="tabs">
    <button class="tab-btn active" onclick="showTab('monitoring')">ğŸ“Š Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ§Ù„Ø±Ø³Ø§Ø¦Ù„</button>
    <button class="tab-btn" onclick="showTab('control')">ğŸ”“ ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹</button>
    <button class="tab-btn" onclick="showTab('teachers')">ğŸ‘¨â€ğŸ« Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</button>
    <button class="tab-btn" onclick="showTab('students')">ğŸ“ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„ÙØµÙˆÙ„</button>
    <button class="tab-btn" onclick="showTab('reset')">ğŸ§¹ ØªØµÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
</div>

<div class="container">
    
    <div id="monitoring" class="content-section active">
        <div class="card">
            <h3>âœ‰ï¸ ØªÙˆØ¬ÙŠÙ‡Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</h3>
            <textarea id="adminMsg" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„ØªÙŠ Ø³ØªØ¸Ù‡Ø± Ù„Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† ÙÙŠ ØµÙØ­Ø§ØªÙ‡Ù…..."></textarea>
            <button class="btn btn-primary" onclick="saveAdminMsg()">Ø­ÙØ¸ ÙˆÙ†Ø´Ø± Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª ğŸš€</button>
        </div>
        <div class="card">
            <h3>ğŸ“Š Ø­Ø§Ù„Ø© Ø±ØµØ¯ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</h3>
            <div id="monTable">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>
    </div>

    <div id="control" class="content-section">
        <div class="card">
            <h3>ğŸ”“ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø±ØµØ¯</h3>
            <p>Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù…ÙØªÙˆØ­ ÙŠÙ…ÙƒÙ† Ù„Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø±ØµØ¯ ÙÙŠÙ‡ØŒ Ø§Ù„Ù…ØºÙ„Ù‚ ÙŠØ¸Ù‡Ø± Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·.</p>
            <div class="status-grid" id="weeksControl"></div>
        </div>
    </div>

    <div id="teachers" class="content-section">
        <div class="card">
            <h3>Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„Ù… Ø¬Ø¯ÙŠØ¯</h3>
            <input type="text" id="tName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…">
            <input type="email" id="tEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Gmail)">
            <input type="text" id="tClasses" placeholder="Ø§Ù„ÙØµÙˆÙ„ (Ù…Ø«Ø§Ù„: 1-Ø£, 2-Ø¨ Ù…Ù‚Ø³ÙˆÙ…Ø© Ø¨ÙØ§ØµÙ„Ø©)">
            <button class="btn btn-primary" onclick="addTeacher()">Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ù„Ù…</button>
        </div>
        <div class="card">
            <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</h3>
            <div id="teachersList"></div>
        </div>
    </div>

    <div id="students" class="content-section">
        <div class="card">
            <h3>Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</h3>
            <input type="text" id="sName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨">
            <input type="text" id="sGrade" placeholder="Ø§Ù„ØµÙ (Ù…Ø«Ø§Ù„: 1)">
            <input type="text" id="sBranch" placeholder="Ø§Ù„ÙØµÙ„ (Ù…Ø«Ø§Ù„: Ø£)">
            <button class="btn btn-primary" onclick="addStudent()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨</button>
        </div>
        <div class="card">
            <h3>Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø­Ø³Ø¨ Ø§Ù„ÙØµÙ„</h3>
            <div style="display:flex; gap:10px;">
                <input type="text" id="fGrade" placeholder="Ø§Ù„ØµÙ">
                <input type="text" id="fBranch" placeholder="Ø§Ù„ÙØµÙ„">
                <button class="btn btn-primary" onclick="loadStudents()">Ø¹Ø±Ø¶</button>
            </div>
            <div id="studentsList"></div>
        </div>
    </div>

    <div id="reset" class="content-section">
        <div class="card" style="border-right: 5px solid var(--danger);">
            <h3>ğŸ§¹ Ù…Ù†Ø·Ù‚Ø© Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
            <p>ØªÙ†Ø¨ÙŠÙ‡: Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù„Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù…Ø®ØªØ§Ø± ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.</p>
            <select id="resetWeekSelector"></select>
            <button class="btn btn-danger" onclick="resetGrades()">ØªØµÙÙŠØ± Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø¢Ù† âš ï¸</button>
        </div>
    </div>

</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyBePGZiqMPmZQdg36jZ4Rkdtd7OISxmob8", projectId: "rasd-tools" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    function showTab(tabId) {
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.currentTarget.classList.add('active');
        if(tabId === 'monitoring') loadMonitoring();
        if(tabId === 'teachers') loadTeachersList();
    }

    window.onload = () => {
        loadSystemConfig();
        loadMonitoring();
        setupResetOptions();
    };

    // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ­ÙƒÙ… (Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©) ---
    async function loadSystemConfig() {
        const doc = await db.collection('system').doc('config').get();
        const data = doc.exists ? doc.data() : { openWeeks: [], message: "" };
        
        let h = '';
        for(let i=1; i<=14; i++) {
            const isOpen = data.openWeeks.includes('w'+i);
            h += `<div class="toggle-box">
                    <b>Ø£Ø³Ø¨ÙˆØ¹ ${i}</b><br>
                    <span class="badge ${isOpen?'badge-open':'badge-closed'}">${isOpen?'Ù…ÙØªÙˆØ­':'Ù…ØºÙ„Ù‚'}</span><br>
                    <input type="checkbox" ${isOpen?'checked':''} onchange="toggleWeek('w${i}', this.checked)">
                  </div>`;
        }
        document.getElementById('weeksControl').innerHTML = h;
        document.getElementById('adminMsg').value = data.message || "";
    }

    async function toggleWeek(wId, status) {
        const ref = db.collection('system').doc('config');
        const doc = await ref.get();
        let current = doc.exists ? doc.data().openWeeks || [] : [];
        if(status) current.push(wId); else current = current.filter(w => w !== wId);
        await ref.set({ openWeeks: current }, {merge:true});
        loadSystemConfig();
    }

    async function saveAdminMsg() {
        await db.collection('system').doc('config').set({ message: document.getElementById('adminMsg').value }, {merge:true});
        alert("ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø© âœ…");
    }

    // --- ÙˆØ¸Ø§Ø¦Ù Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† ÙˆØ§Ù„Ø·Ù„Ø§Ø¨ (Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚) ---
    async function addTeacher() {
        const name = document.getElementById('tName').value;
        const email = document.getElementById('tEmail').value;
        const classes = document.getElementById('tClasses').value.split(',').map(c => c.trim());
        if(!name || !email) return alert("Ø§ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        await db.collection('teachers').doc(email).set({ name, classes });
        alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
        loadTeachersList();
    }

    async function loadTeachersList() {
        const snap = await db.collection('teachers').get();
        let h = '<table><tr><th>Ø§Ù„Ù…Ø¹Ù„Ù…</th><th>Ø§Ù„Ø§ÙŠÙ…ÙŠÙ„</th><th>Ø§Ù„ÙØµÙˆÙ„</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr>';
        snap.forEach(doc => {
            const t = doc.data();
            h += `<tr><td>${t.name}</td><td>${doc.id}</td><td>${t.classes.join(', ')}</td>
                  <td><button class="btn-danger" onclick="deleteDoc('teachers','${doc.id}')">Ø­Ø°Ù</button></td></tr>`;
        });
        document.getElementById('teachersList').innerHTML = h + '</table>';
    }

    async function addStudent() {
        const name = document.getElementById('sName').value;
        const grade = document.getElementById('sGrade').value;
        const branch = document.getElementById('sBranch').value;
        await db.collection('students').add({ name, grade, branch, sortOrder: Date.now() });
        alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨");
    }

    async function loadStudents() {
        const g = document.getElementById('fGrade').value;
        const b = document.getElementById('fBranch').value;
        const snap = await db.collection('students').where('grade','==',g).where('branch','==',b).get();
        let h = '<ul>';
        snap.forEach(doc => h += `<li>${doc.data().name} <button onclick="deleteDoc('students','${doc.id}')">Ø­Ø°Ù</button></li>`);
        document.getElementById('studentsList').innerHTML = h + '</ul>';
    }

    async function deleteDoc(col, id) {
        if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) {
            await db.collection(col).doc(id).delete();
            alert("ØªÙ… Ø§Ù„Ø­Ø°Ù");
            location.reload();
        }
    }

    // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ§Ù„ØªØµÙÙŠØ± ---
    async function loadMonitoring() {
        const teachers = await db.collection('teachers').get();
        const grades = await db.collection('grades').get();
        let h = '<table><tr><th>Ø§Ù„Ù…Ø¹Ù„Ù…</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø±ØµÙˆØ¯Ø©</th></tr>';
        teachers.forEach(tDoc => {
            const count = grades.docs.filter(g => g.data().teacher === tDoc.id).length;
            h += `<tr><td>${tDoc.data().name}</td><td>${count} Ø¯Ø±Ø¬Ø© Ù…Ø±ØµÙˆØ¯Ø©</td></tr>`;
        });
        document.getElementById('monTable').innerHTML = h + '</table>';
    }

    function setupResetOptions() {
        const sel = document.getElementById('resetWeekSelector');
        for(let i=1; i<=14; i++) sel.innerHTML += `<option value="w${i}">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${i}</option>`;
        sel.innerHTML += `<option value="ex1">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± 1</option><option value="ex2">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± 2</option>`;
    }

    async function resetGrades() {
        const w = document.getElementById('resetWeekSelector').value;
        if(!confirm(`Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø¯Ø±Ø¬Ø§Øª ${w} Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ`)) return;
        const snap = await db.collection('grades').where('week','==',w).get();
        const batch = db.batch();
        snap.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
        alert("ØªÙ… Ø§Ù„ØªØµÙÙŠØ± Ø¨Ù†Ø¬Ø§Ø­");
    }
</script>
</body>
</html>
