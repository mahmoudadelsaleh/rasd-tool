<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø±ØµØ¯ Ø§Ù„Ø°ÙƒÙŠ - Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø§Ø³ØªØ±</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --sidebar: #0f172a; --accent: #3b82f6; --danger: #ef4444; --success: #10b981; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f1f5f9; margin: 0; display: flex; flex-direction: column; align-items: center; }
        .app-container { width: 100%; max-width: 500px; min-height: 100vh; background: #f1f5f9; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        header { background: var(--sidebar); color: white; padding: 15px; text-align: center; }
        .tabs-nav { display: grid; grid-template-columns: repeat(3, 1fr); background: white; position: sticky; top: 0; z-index: 1000; }
        .tab-btn { padding: 12px 5px; border: none; background: none; font-weight: bold; font-size: 11px; color: #64748b; border-bottom: 2px solid transparent; cursor: pointer; }
        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); background: #f0f7ff; }
        .content-area { padding: 15px; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; animation: fadeIn 0.3s; }
        .card { background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #cbd5e1; box-sizing: border-box; }
        .btn-main { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; color: white; margin-top: 5px; }
        .grid-checks { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; background: #f8fafc; padding: 10px; border-radius: 10px; }
        .check-item { background: white; border: 1px solid #e2e8f0; padding: 5px 10px; border-radius: 20px; font-size: 11px; display: flex; align-items: center; gap: 5px; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="app-container">
    <header><b>Ø§Ù„Ù…Ø§Ø³ØªØ± | Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</b></header>

    <div class="tabs-nav">
        <button class="tab-btn active" onclick="openTab(event, 'stats')">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
        <button class="tab-btn" onclick="openTab(event, 'teachers')">ğŸ‘¨â€ğŸ« Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</button>
        <button class="tab-btn" onclick="openTab(event, 'students')">ğŸ“ Ø§Ù„Ø·Ù„Ø§Ø¨</button>
        <button class="tab-btn" onclick="openTab(event, 'control')">ğŸ”“ Ø§Ù„Ø£Ù‚ÙØ§Ù„</button>
        <button class="tab-btn" onclick="openTab(event, 'reset')">ğŸ§¹ Ø§Ù„ØªØµÙÙŠØ±</button>
        <button class="tab-btn" onclick="openTab(event, 'export')">ğŸ“¥ Ø§Ù„ØªØµØ¯ÙŠØ±</button>
    </div>

    <div class="content-area">
        
        <div id="export" class="tab-panel">
            <div class="card">
                <h4>ğŸ“¥ ØªØµØ¯ÙŠØ± ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙØªØ±Ø§Øª</h4>
                <select id="expGrade">
                    <option value="1_general">Ø£ÙˆÙ„Ù‰ Ø«Ø§Ù†ÙˆÙŠ Ø¹Ø§Ù…</option>
                    <option value="2_scientific">Ø«Ø§Ù†ÙŠØ© Ø«Ø§Ù†ÙˆÙŠ Ø¹Ù„Ù…ÙŠ</option>
                    <option value="2_literary">Ø«Ø§Ù†ÙŠØ© Ø«Ø§Ù†ÙˆÙŠ Ø£Ø¯Ø¨ÙŠ</option>
                </select>
                <button class="btn-main" style="background:#3b82f6" onclick="exportPeriodReport(1)">ØªØµØ¯ÙŠØ± "Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰" (ÙƒÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†)</button>
                <button class="btn-main" style="background:#1d4ed8" onclick="exportPeriodReport(2)">ØªØµØ¯ÙŠØ± "Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©" (ÙƒÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†)</button>
                <hr>
                <button class="btn-main" style="background:#10b981" onclick="exportTeacherFullReport()">ØªÙ‚Ø±ÙŠØ± ÙƒÙ„ Ù…Ø¹Ù„Ù… (Ø´ÙŠØª Ù…Ø³ØªÙ‚Ù„ - ÙƒÙ„ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹)</button>
                <button class="btn-main" style="background:#8b5cf6" onclick="exportFinalConsolidated()">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø®ØªØ§Ù…ÙŠ Ø§Ù„Ù…Ø¬Ù…Ø¹ (70 Ø¯Ø±Ø¬Ø©)</button>
                <div id="expStatus" style="text-align:center; font-size:11px; margin-top:10px;"></div>
            </div>
        </div>

        <div id="reset" class="tab-panel">
            <div class="card" style="border-right: 5px solid var(--danger);">
                <h4>ğŸ§¹ Ø§Ù„ØªØµÙÙŠØ± Ø§Ù„Ø°ÙƒÙŠ (Ø§Ù„Ù…ØªØ¹Ø¯Ø¯)</h4>
                <label>1. Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¹Ù„Ù…:</label>
                <select id="resTeacher" onchange="loadResetCheckboxes()"></select>
                
                <label>2. Ø­Ø¯Ø¯ Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©:</label>
                <div id="resClassesChecks" class="grid-checks"></div>
                
                <label>3. Ø­Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§Ø¯ Ù…Ø³Ø­Ù‡Ø§:</label>
                <div id="resWeeksChecks" class="grid-checks"></div>
                
                <button class="btn-main" style="background:var(--danger)" onclick="performBulkReset()">Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ âš ï¸</button>
            </div>
        </div>

        <div id="stats" class="tab-panel active"> </div>
        <div id="teachers" class="tab-panel"> </div>
        <div id="students" class="tab-panel"> </div>
        <div id="control" class="tab-panel"> </div>

    </div>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyBePGZiqMPmZQdg36jZ4Rkdtd7OISxmob8", projectId: "rasd-tools" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let teachers = [], students = [], grades = [], config = {};

    window.onload = async () => { await loadAllData(); };

    async function loadAllData() {
        const tSnap = await db.collection('teachers').get();
        teachers = tSnap.docs.map(doc => ({id: doc.id, ...doc.data()}));
        const sSnap = await db.collection('students').get();
        students = sSnap.docs.map(doc => ({id: doc.id, ...doc.data()}));
        const gSnap = await db.collection('grades').get();
        grades = gSnap.docs.map(doc => doc.data());
        const confSnap = await db.collection('system').doc('config').get();
        config = confSnap.exists ? confSnap.data() : { openWeeks: [], ex1W: 'w6', ex2W: 'w12' };
        
        loadTeachersToReset(); // Ù„ØªØ¬Ù‡ÙŠØ² Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØµÙÙŠØ±
    }

    function openTab(evt, tabId) {
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        evt.currentTarget.classList.add('active');
    }

    // --- Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØµÙÙŠØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Checkboxes) ---
    function loadTeachersToReset() {
        const sel = document.getElementById('resTeacher');
        sel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¹Ù„Ù…...</option>';
        teachers.forEach(t => sel.innerHTML += `<option value="${t.id}">${t.name}</option>`);
    }

    function loadResetCheckboxes() {
        const tId = document.getElementById('resTeacher').value;
        const t = teachers.find(x => x.id === tId);
        const clsContainer = document.getElementById('resClassesChecks');
        const weekContainer = document.getElementById('resWeeksChecks');
        
        clsContainer.innerHTML = ''; weekContainer.innerHTML = '';
        if(!t) return;

        // ÙØµÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…
        t.classes.forEach(c => {
            clsContainer.innerHTML += `<label class="check-item"><input type="checkbox" name="resCls" value="${c}"> ${c}</label>`;
        });

        // Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ (Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ÙØ¹Ù„ÙŠØ§Ù‹ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ù„Ù…)
        const activeWeeks = [...new Set(grades.filter(g => g.teacher === tId).map(g => g.week))].sort();
        activeWeeks.forEach(w => {
            weekContainer.innerHTML += `<label class="check-item"><input type="checkbox" name="resWk" value="${w}"> ${w}</label>`;
        });
    }

    async function performBulkReset() {
        const tId = document.getElementById('resTeacher').value;
        const selectedCls = Array.from(document.querySelectorAll('input[name="resCls"]:checked')).map(el => el.value);
        const selectedWks = Array.from(document.querySelectorAll('input[name="resWk"]:checked')).map(el => el.value);

        if(!tId || selectedCls.length === 0 || selectedWks.length === 0) {
            return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¹Ù„Ù… ÙˆØ§Ù„ÙØµÙˆÙ„ ÙˆØ§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØµÙÙŠØ±Ù‡Ø§.");
        }

        if(confirm(`Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª ${selectedCls.length} ÙØµÙˆÙ„ Ù„Ø¹Ø¯Ø¯ ${selectedWks.length} Ø£Ø³Ø§Ø¨ÙŠØ¹. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ`)) {
            const batch = db.batch();
            const snap = await db.collection('grades')
                .where('teacher', '==', tId)
                .where('week', 'in', selectedWks)
                .get();
            
            let count = 0;
            snap.forEach(doc => {
                // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù†Ø­ØªØ§Ø¬ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø·Ø§Ù„Ø¨ ÙÙŠ Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© (ÙŠØªØ·Ù„Ø¨ Ø±Ø¨Ø· sid Ø¨Ø§Ù„ÙØµÙ„)
                batch.delete(doc.ref);
                count++;
            });
            await batch.commit();
            alert(`ØªÙ… ØªØµÙÙŠØ± ${count} Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­ âœ…`);
            loadAllData();
        }
    }

    // --- Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø·ÙˆØ± (Ø§Ù„ÙØªØ±Ø§Øª ÙˆØ§Ù„Ø´ÙŠØªØ§Øª) ---
    async function exportPeriodReport(periodNum) {
        const gradeVal = document.getElementById('expGrade').value;
        const start = periodNum === 1 ? 1 : 8;
        const end = periodNum === 1 ? 7 : 14;
        const exW = periodNum === 1 ? config.ex1W : config.ex2W;
        
        const wb = XLSX.utils.book_new();
        const relevantTeachers = teachers.filter(t => t.classes.includes(gradeVal));

        relevantTeachers.forEach(t => {
            const sheetData = students.filter(s => t.classes.includes(`${s.grade}_${s.branch}`)).map(student => {
                const sGrades = grades.filter(g => g.sid === student.id && g.teacher === t.id);
                const avg = (type) => {
                    const vals = sGrades.filter(g => g.type === type && g.week >= 'w'+start && g.week <= 'w'+end).map(g => g.score);
                    return vals.length ? (vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(2) : 0;
                };
                const ex = sGrades.find(g => g.week === exW && g.type === 'exam');
                return {
                    "Ø§Ù„Ø·Ø§Ù„Ø¨": student.name,
                    "Ø§Ù„ØªÙ‚ÙŠÙŠÙ… (15)": avg('t'), "Ø§Ù„ÙˆØ§Ø¬Ø¨ (15)": avg('v'), "Ø§Ù„Ø³Ù„ÙˆÙƒ (10)": avg('s'),
                    "Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±": ex ? ex.score : 0
                };
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(sheetData), t.name.substring(0,25));
        });
        XLSX.writeFile(wb, `ØªÙ‚Ø±ÙŠØ±_Ø§Ù„ÙØªØ±Ø©_${periodNum}_${gradeVal}.xlsx`);
    }

    async function exportTeacherFullReport() {
        const wb = XLSX.utils.book_new();
        teachers.forEach(t => {
            const data = students.filter(s => t.classes.some(c => c.includes(s.grade))).map(student => {
                const row = { "Ø§Ù„Ø·Ø§Ù„Ø¨": student.name };
                for(let i=1; i<=14; i++) {
                    const g = grades.find(rg => rg.sid === student.id && rg.teacher === t.id && rg.week === 'w'+i && rg.type === 't');
                    row[`Ø£Ø³Ø¨ÙˆØ¹ ${i}`] = g ? g.score : '-';
                }
                const ex1 = grades.find(rg => rg.sid === student.id && rg.teacher === t.id && rg.week === 'ex1');
                const ex2 = grades.find(rg => rg.sid === student.id && rg.teacher === t.id && rg.week === 'ex2');
                row["Ø§Ø®ØªØ¨Ø§Ø± 1"] = ex1 ? ex1.score : 0;
                row["Ø§Ø®ØªØ¨Ø§Ø± 2"] = ex2 ? ex2.score : 0;
                return row;
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), t.name.substring(0,25));
        });
        XLSX.writeFile(wb, `ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†_Ø§Ù„Ø´Ø§Ù…Ù„.xlsx`);
    }

</script>
</body>
</html>
