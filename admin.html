<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© v2026</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --sidebar: #1e293b; --accent: #3b82f6; --danger: #ef4444; --success: #10b981; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f8fafc; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        header { background: var(--sidebar); color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; }
        .tabs-nav { display: flex; background: white; padding: 5px; gap: 5px; overflow-x: auto; border-bottom: 1px solid #e2e8f0; }
        .tab-btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; background: #f1f5f9; color: #64748b; }
        .tab-btn.active { background: var(--accent); color: white; }
        .content-area { flex: 1; overflow-y: auto; padding: 20px; }
        .tab-panel { display: none; max-width: 1000px; margin: auto; animation: fadeIn 0.3s ease; }
        .tab-panel.active { display: block; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #cbd5e1; box-sizing: border-box; }
        .btn-main { background: var(--sidebar); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; }
        .btn-update { background: #d97706; color: white; } /* Ù„ÙˆÙ† Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { background: #f1f5f9; padding: 12px; text-align: right; font-size: 13px; color: #475569; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; }
        .badge { padding: 2px 8px; background: #e2e8f0; border-radius: 4px; font-size: 11px; margin-left: 3px; }
        .action-btn { border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-weight: bold; margin-left: 5px; }
        .edit-btn { background: #fef3c7; color: #92400e; }
        .del-btn { background: #fee2e2; color: #991b1b; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<header>
    <div><b>Ù†Ø¸Ø§Ù… Ø§Ù„Ø±ØµØ¯ Ø§Ù„Ø°ÙƒÙŠ</b> | Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
    <div id="status" style="font-size: 12px; color: #94a3b8;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
</header>

<div class="tabs-nav">
    <button class="tab-btn active" onclick="openTab(event, 'stats')">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
    <button class="tab-btn" onclick="openTab(event, 'teachers')">ğŸ‘¨â€ğŸ« Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</button>
    <button class="tab-btn" onclick="openTab(event, 'students')">ğŸ“ Ø§Ù„Ø·Ù„Ø§Ø¨</button>
    <button class="tab-btn" onclick="openTab(event, 'export')">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
</div>

<div class="content-area">
    
    <div id="stats" class="tab-panel active">
        <div class="card">
            <h2>Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø©</h2>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div style="text-align:center; padding:20px; background:#eff6ff; border-radius:10px; border-top:4px solid var(--accent);">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†<br><b id="countT" style="font-size:28px;">0</b></div>
                <div style="text-align:center; padding:20px; background:#ecfdf5; border-radius:10px; border-top:4px solid var(--success);">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨<br><b id="countS" style="font-size:28px;">0</b></div>
            </div>
        </div>
    </div>

    <div id="teachers" class="tab-panel">
        <div class="card">
            <h3 id="tFormTitle">ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹Ù„Ù… Ø¬Ø¯ÙŠØ¯</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <input type="text" id="tName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„">
                <input type="text" id="tSub" placeholder="Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©">
                <input type="text" id="tUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯)">
                <input type="text" id="tPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            </div>
            <label style="font-size: 12px;">Ø§Ù„ÙØµÙˆÙ„ (Ø§ÙØµÙ„ Ø¨ÙŠÙ†Ù‡Ø§ Ø¨ÙØ§ØµÙ„Ø© Ù…Ø«Ù„: 1_general, 2_scientific):</label>
            <input type="text" id="tClasses" placeholder="1_general, 2_scientific">
            
            <button id="btnSaveT" class="btn-main" onclick="saveTeacher()">Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ù„Ù…</button>
            <button id="btnCancelEdit" class="btn-main" style="background:#64748b; margin-top:5px; display:none;" onclick="cancelEdit()">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
        </div>

        <div class="card">
            <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†</h3>
            <div style="overflow-x:auto;">
                <table>
                    <thead><tr><th>Ø§Ù„Ù…Ø¹Ù„Ù…</th><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„Ù…Ø³Ù†Ø¯Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                    <tbody id="tBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="students" class="tab-panel">
        <div class="card">
            <h3>Ø±ÙØ¹ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
            <select id="sGrade">
                <option value="1_general">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ</option>
                <option value="2_scientific">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø«Ø§Ù†ÙˆÙŠ (Ø¹Ù„Ù…ÙŠ)</option>
                <option value="2_literary">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø«Ø§Ù†ÙˆÙŠ (Ø£Ø¯Ø¨ÙŠ)</option>
            </select>
            <textarea id="sNames" rows="8" placeholder="Ø§Ù„ØµÙ‚ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ù‡Ù†Ø§.. Ø§Ø³Ù… ÙˆØ§Ø­Ø¯ ÙÙŠ ÙƒÙ„ Ø³Ø·Ø±"></textarea>
            <button class="btn-main" onclick="uploadStudents()">Ø¨Ø¯Ø¡ Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ø°ÙƒÙŠ</button>
        </div>
    </div>

    <div id="export" class="tab-panel">
        <div class="card" style="border-right: 5px solid var(--success);">
            <h2>ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</h2>
            <p style="font-size:13px; color:#64748b;">ÙŠØªÙ… Ø¯Ù…Ø¬ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙˆØ§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ø£ÙˆØ²Ø§Ù† Ø§Ù„Ù†Ø³Ø¨ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</p>
            <select id="expGrade">
                <option value="1_general">1 Ø«Ø§Ù†ÙˆÙŠ</option>
                <option value="2_scientific">2 Ø«Ø§Ù†ÙˆÙŠ Ø¹Ù„Ù…ÙŠ</option>
                <option value="2_literary">2 Ø«Ø§Ù†ÙˆÙŠ Ø£Ø¯Ø¨ÙŠ</option>
            </select>
            <button class="btn-main" style="background:var(--success)" onclick="exportComprehensiveExcel()">ØªØµØ¯ÙŠØ± Ù…Ù„Ù Excel Ø§Ù„Ù…Ø¬Ù…Ø¹</button>
            <div id="expStatus" style="margin-top:15px; font-weight:bold; color:var(--success);"></div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyBePGZiqMPmZQdg36jZ4Rkdtd7OISxmob8", projectId: "rasd-tools" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let teachers = [], students = [], isEditMode = false;

    function openTab(evt, tabId) {
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        evt.currentTarget.classList.add('active');
    }

    async function loadData() {
        document.getElementById('status').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...";
        const tSnap = await db.collection('teachers').get();
        teachers = tSnap.docs.map(doc => ({id: doc.id, ...doc.data()}));
        const sSnap = await db.collection('students').get();
        students = sSnap.docs.map(doc => ({id: doc.id, ...doc.data()}));
        
        document.getElementById('countT').innerText = teachers.length;
        document.getElementById('countS').innerText = students.length;
        document.getElementById('status').innerText = "Ù…ØªØµÙ„ âœ…";
        renderTeachers();
    }

    function renderTeachers() {
        const b = document.getElementById('tBody'); b.innerHTML = '';
        teachers.forEach(t => {
            let classesHtml = t.classes ? t.classes.map(c => `<span class="badge">${c}</span>`).join('') : '-';
            b.innerHTML += `<tr>
                <td><b>${t.name}</b></td>
                <td>${t.subject}</td>
                <td>${classesHtml}</td>
                <td>
                    <button class="action-btn edit-btn" onclick="prepareEdit('${t.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
                    <button class="action-btn del-btn" onclick="deleteTeacher('${t.id}')">Ø­Ø°Ù</button>
                </td>
            </tr>`;
        });
    }

    // ØªØ¬Ù‡ÙŠØ² Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù… Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
    function prepareEdit(id) {
        const t = teachers.find(x => x.id === id);
        if(!t) return;
        
        isEditMode = true;
        document.getElementById('tFormTitle').innerText = "ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª: " + t.name;
        document.getElementById('tUser').value = t.id;
        document.getElementById('tUser').readOnly = true; // Ù„Ø§ Ù†Ø¹Ø¯Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø£Ù†Ù‡ Ø§Ù„Ù…ÙØªØ§Ø­
        document.getElementById('tName').value = t.name;
        document.getElementById('tSub').value = t.subject;
        document.getElementById('tPass').value = t.pass;
        document.getElementById('tClasses').value = t.classes ? t.classes.join(', ') : '';
        
        document.getElementById('btnSaveT').innerText = "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¢Ù†";
        document.getElementById('btnSaveT').classList.add('btn-update');
        document.getElementById('btnCancelEdit').style.display = "block";
        
        // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
        document.querySelector('#teachers .card').scrollIntoView({behavior: 'smooth'});
    }

    function cancelEdit() {
        isEditMode = false;
        document.getElementById('tFormTitle').innerText = "ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹Ù„Ù… Ø¬Ø¯ÙŠØ¯";
        document.getElementById('tUser').value = '';
        document.getElementById('tUser').readOnly = false;
        document.getElementById('tName').value = '';
        document.getElementById('tSub').value = '';
        document.getElementById('tPass').value = '';
        document.getElementById('tClasses').value = '';
        document.getElementById('btnSaveT').innerText = "Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ù„Ù…";
        document.getElementById('btnSaveT').classList.remove('btn-update');
        document.getElementById('btnCancelEdit').style.display = "none";
    }

    async function saveTeacher() {
        const id = document.getElementById('tUser').value.trim();
        if(!id) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
        
        const data = {
            name: document.getElementById('tName').value.trim(),
            subject: document.getElementById('tSub').value.trim(),
            pass: document.getElementById('tPass').value.trim(),
            classes: document.getElementById('tClasses').value.split(',').map(c => c.trim()).filter(c => c)
        };
        
        await db.collection('teachers').doc(id).set(data, {merge:true});
        alert(isEditMode ? "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª âœ…" : "ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ù„Ù… âœ…");
        cancelEdit();
        loadData();
    }

    async function deleteTeacher(id) {
        if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ù„Ù…ØŸ Ø³ÙŠØªÙ… Ø¥Ù„ØºØ§Ø¡ ÙˆØµÙˆÙ„Ù‡ Ù„Ù„Ù†Ø¸Ø§Ù… Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.")) {
            await db.collection('teachers').doc(id).delete();
            loadData();
        }
    }

    async function uploadStudents() {
        const names = document.getElementById('sNames').value.split('\n').filter(n => n.trim());
        const grade = document.getElementById('sGrade').value;
        const [g, b] = grade.split('_');
        const batch = db.batch();
        names.forEach(n => {
            const ref = db.collection('students').doc();
            batch.set(ref, {name: n.trim(), grade: g, branch: b, sortOrder: Date.now()});
        });
        await batch.commit();
        alert("ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
        document.getElementById('sNames').value = '';
        loadData();
    }

    async function exportComprehensiveExcel() {
        const gradeVal = document.getElementById('expGrade').value;
        const status = document.getElementById('expStatus');
        status.innerText = "â³ Ø¬Ø§Ø±ÙŠ ØªØ¬Ù…ÙŠØ¹ ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...";
        
        try {
            const [g, b] = gradeVal.split('_');
            const targetStudents = students.filter(s => s.grade === g && s.branch === b).sort((a,b)=>a.sortOrder - b.sortOrder);
            const gSnap = await db.collection('grades').get();
            const allGrades = gSnap.docs.map(d => d.data());
            
            const wb = XLSX.utils.book_new();
            const relevantTeachers = teachers.filter(t => t.classes && t.classes.includes(gradeVal));
            const subjects = [...new Set(relevantTeachers.map(t => t.subject))];

            subjects.forEach(sub => {
                const subTeachers = relevantTeachers.filter(t => t.subject === sub);
                const tIds = subTeachers.map(t => t.id);

                const sheetData = targetStudents.map(student => {
                    const sGrades = allGrades.filter(rg => rg.sid === student.id && tIds.includes(rg.teacher));
                    const mainT = subTeachers[0];
                    const ex1W = mainT.exam1Week || "w6";
                    const ex2W = mainT.exam2Week || "w10";

                    const calcAvg = (type) => {
                        const vals = sGrades.filter(v => v.type === type && v.week !== ex1W && v.week !== ex2W && !v.week.startsWith('ex'))
                                           .map(v => v.score);
                        return vals.length ? parseFloat((vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(2)) : 0;
                    };

                    const getExamScore = (exKey) => {
                        const entry = sGrades.find(v => v.week === exKey && v.type === 'exam');
                        if(!entry) return 0;
                        let s = parseFloat(entry.score) || 0;
                        return (entry.maxSet === 15) ? s * 2 : s;
                    };

                    const ex1Score = getExamScore('ex1');
                    const ex2Score = getExamScore('ex2');
                    const avgExams = parseFloat(((ex1Score + ex2Score) / 2).toFixed(2));

                    const avgT = calcAvg('t');
                    const avgV = calcAvg('v');
                    const avgS = calcAvg('s');

                    return {
                        "Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨": student.name,
                        "Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª (15)": avgT,
                        "Ø§Ù„Ø­ØµØ© ÙˆØ§Ù„ÙˆØ§Ø¬Ø¨ (15)": avgV,
                        "Ø§Ù„Ø³Ù„ÙˆÙƒ (10)": avgS,
                        "Ù…ØªÙˆØ³Ø· Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª (30)": avgExams,
                        "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (70)": parseFloat((avgT + avgV + avgS + avgExams).toFixed(2))
                    };
                });

                const ws = XLSX.utils.json_to_sheet(sheetData);
                XLSX.utils.book_append_sheet(wb, ws, sub);
            });

            XLSX.writeFile(wb, `ØªÙ‚Ø±ÙŠØ±_Ù†ØªØ§Ø¦Ø¬_${gradeVal}.xlsx`);
            status.innerText = "âœ… ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­!";
        } catch (e) {
            status.innerText = "âŒ ÙØ´Ù„ Ø§Ù„ØªØµØ¯ÙŠØ±: " + e.message;
        }
    }

    window.onload = loadData;
</script>
</body>
</html>
