<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© v2026</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --admin-bg: #f8fafc; --sidebar: #0f172a; --accent: #3b82f6; --danger: #ef4444; --success: #22c55e; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--admin-bg); margin: 0; padding: 0; }
        
        /* Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
        header { background: var(--sidebar); color: white; padding: 20px; text-align: center; }
        .tabs { display: flex; background: white; border-bottom: 1px solid #e2e8f0; overflow-x: auto; sticky: top; }
        .tab-btn { padding: 15px 20px; border: none; background: none; cursor: pointer; font-weight: bold; color: #64748b; min-width: 120px; }
        .tab-btn.active { color: var(--accent); border-bottom: 3px solid var(--accent); background: #eff6ff; }
        
        .container { padding: 20px; max-width: 1000px; margin: auto; }
        .card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .content-section { display: none; }
        .content-section.active { display: block; }

        /* Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„ÙØªØ­/Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ */
        .status-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
        .toggle-box { padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; text-align: center; }
        
        /* Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th, td { padding: 12px; text-align: right; border-bottom: 1px solid #e2e8f0; }
        th { background: #f1f5f9; }
        .progress-bar { background: #e2e8f0; border-radius: 10px; height: 10px; width: 100px; display: inline-block; overflow: hidden; }
        .progress-fill { background: var(--success); height: 100%; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© */
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-primary { background: var(--accent); color: white; }
        textarea { width: 100%; height: 100px; border-radius: 8px; border: 1px solid #cbd5e1; padding: 10px; font-family: inherit; }
        
        .badge { padding: 2px 8px; border-radius: 10px; font-size: 11px; }
        .badge-open { background: #dcfce7; color: #166534; }
        .badge-closed { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>

<header>
    <h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©</h1>
    <p>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„Ø±ØµØ¯ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ</p>
</header>

<div class="tabs">
    <button class="tab-btn active" onclick="showTab('monitoring')">ğŸ“Š Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©</button>
    <button class="tab-btn" onclick="showTab('control')">ğŸ”“ ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚</button>
    <button class="tab-btn" onclick="showTab('reset')">ğŸ§¹ ØªØµÙÙŠØ±</button>
    <button class="tab-btn" onclick="showTab('messaging')">âœ‰ï¸ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª</button>
</div>

<div class="container">
    
    <div id="monitoring" class="content-section active">
        <div class="card">
            <h3>ØªÙ‚Ø¯Ù… Ø±ØµØ¯ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</h3>
            <div id="monTable">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>
    </div>

    <div id="control" class="content-section">
        <div class="card">
            <h3>Ø­Ø§Ù„Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø±ØµØ¯</h3>
            <p>ØªØ­ÙƒÙ… ÙÙŠ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„Ø±ØµØ¯ Ù„Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† (Ø£Ø³Ø¨ÙˆØ¹ÙŠØ§Ù‹)</p>
            <div class="status-grid" id="weeksControl">
                </div>
        </div>
    </div>

    <div id="reset" class="content-section">
        <div class="card" style="border-right: 5px solid var(--danger);">
            <h3>ØªØµÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù…Ù†Ø·Ù‚Ø© Ø­Ø³Ø§Ø³Ø©)</h3>
            <p>Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù…Ø®ØªØ§Ø±:</p>
            <select id="resetWeek" style="padding:10px; width: 100%; margin-bottom:15px;">
                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø£Ùˆ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...</option>
            </select>
            <button class="btn btn-danger" onclick="resetGrades()">ØªØµÙÙŠØ± Ø§Ù„Ø¢Ù† âš ï¸</button>
        </div>
    </div>

    <div id="messaging" class="content-section">
        <div class="card">
            <h3>Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ù„Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</h3>
            <p>Ø³ØªØ¸Ù‡Ø± Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø£Ø¹Ù„Ù‰ ØµÙØ­Ø© ÙƒÙ„ Ù…Ø¹Ù„Ù… Ø¹Ù†Ø¯ ÙØªØ­Ù‡ Ù„Ù„Ù†Ø¸Ø§Ù…</p>
            <textarea id="adminMsg" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù…Ù† Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹..."></textarea>
            <button class="btn btn-primary" onclick="saveMessage()" style="margin-top:10px;">Ù†Ø´Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø© ğŸš€</button>
        </div>
    </div>

</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyBePGZiqMPmZQdg36jZ4Rkdtd7OISxmob8", projectId: "rasd-tools" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
    function showTab(tabId) {
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.currentTarget.classList.add('active');
        if(tabId === 'monitoring') loadMonitoring();
    }

    window.onload = () => {
        loadSettings();
        loadMonitoring();
        setupResetDropdown();
    };

    // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… (ÙØªØ­ ÙˆØ¥ØºÙ„Ø§Ù‚)
    async function loadSettings() {
        const setDoc = await db.collection('system').doc('config').get();
        const data = setDoc.exists ? setDoc.data() : { openWeeks: [] };
        let h = '';
        for(let i=1; i<=14; i++) {
            const isOpen = data.openWeeks && data.openWeeks.includes('w'+i);
            h += `<div class="toggle-box">
                    <b>Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${i}</b><br>
                    <span class="badge ${isOpen?'badge-open':'badge-closed'}">${isOpen?'Ù…ÙØªÙˆØ­':'Ù…ØºÙ„Ù‚'}</span><br>
                    <input type="checkbox" ${isOpen?'checked':''} onchange="toggleWeek('w${i}', this.checked)">
                  </div>`;
        }
        document.getElementById('weeksControl').innerHTML = h;
        if(data.message) document.getElementById('adminMsg').value = data.message;
    }

    async function toggleWeek(weekId, status) {
        const docRef = db.collection('system').doc('config');
        const doc = await docRef.get();
        let current = doc.exists ? doc.data().openWeeks || [] : [];
        if(status) current.push(weekId); else current = current.filter(w => w !== weekId);
        await docRef.set({ openWeeks: current }, {merge:true});
        loadSettings();
    }

    // Ù…Ø±Ø§Ù‚Ø¨Ø© ØªÙ‚Ø¯Ù… Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†
    async function loadMonitoring() {
        const teachersSnap = await db.collection('teachers').get();
        const gradesSnap = await db.collection('grades').get();
        
        let h = `<table><tr><th>Ø§Ù„Ù…Ø¹Ù„Ù…</th><th>Ø§Ù„Ø·Ù„Ø§Ø¨</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr>`;
        
        teachersSnap.forEach(tDoc => {
            const t = tDoc.data();
            const teacherGrades = gradesSnap.docs.filter(g => g.data().teacher === tDoc.id).length;
            // Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ù†Ø­Ø³Ø¨ Ø§Ù„ØªÙ‚Ø¯Ù… Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø±ØµÙˆØ¯Ø© (ÙŠÙ…ÙƒÙ† ØªØ·ÙˆÙŠØ±Ù‡Ø§ Ù…Ø³ØªÙ‚Ø¨Ù„Ø§Ù‹)
            h += `<tr>
                    <td>${t.name}</td>
                    <td>${teacherGrades} Ø­Ø±ÙƒØ© Ø±ØµØ¯</td>
                    <td><div class="progress-bar"><div class="progress-fill" style="width:${Math.min(teacherGrades, 100)}%"></div></div></td>
                  </tr>`;
        });
        h += `</table>`;
        document.getElementById('monTable').innerHTML = h;
    }

    // ØªØµÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    async function resetGrades() {
        const week = document.getElementById('resetWeek').value;
        if(!week) return alert("Ø§Ø®ØªØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø£ÙˆÙ„Ø§Ù‹");
        if(!confirm(`âš ï¸ ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¯Ø±Ø¬Ø§Øª (${week}) Ù„ÙƒÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ`)) return;

        const snap = await db.collection('grades').where('week', '==', week).get();
        const batch = db.batch();
        snap.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
        alert("ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…");
    }

    function setupResetDropdown() {
        const sel = document.getElementById('resetWeek');
        for(let i=1; i<=14; i++) sel.innerHTML += `<option value="w${i}">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${i}</option>`;
        sel.innerHTML += `<option value="ex1">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø£ÙˆÙ„</option><option value="ex2">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ</option>`;
    }

    async function saveMessage() {
        const msg = document.getElementById('adminMsg').value;
        await db.collection('system').doc('config').set({ message: msg }, {merge:true});
        alert("ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† âœ‰ï¸");
    }
</script>
</body>
</html>
