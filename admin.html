<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø§Ø³ØªØ± v2026 - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©</title>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="firebase-config.js"></script>

    <style>
        :root {
            --primary: #0f172a;
            --accent: #3b82f6;
            --danger: #ef4444;
            --success: #10b981;
            --bg: #f1f5f9;
        }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; direction: rtl; }
        .app-container { width: 100%; max-width: 600px; margin: auto; min-height: 100vh; background: var(--bg); }
        header { background: var(--primary); color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 1001; }
        
        .tabs-nav { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            background: white; 
            border-bottom: 2px solid #e2e8f0; 
            position: sticky; 
            top: 54px; 
            z-index: 1000; 
        }
        .tab-btn { padding: 12px; border: none; background: none; font-weight: bold; font-size: 13px; color: #64748b; border-bottom: 2px solid transparent; cursor: pointer; }
        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); background: #f0f7ff; }
        
        .content-area { padding: 15px; padding-bottom: 80px; }
        .tab-panel { display: none; animation: fadeIn 0.3s; }
        .tab-panel.active { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .btn-main { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: bold; color: white; margin-bottom: 8px; cursor: pointer; transition: 0.2s; }
        .btn-main:active { transform: scale(0.98); }
        
        input, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #cbd5e1; box-sizing: border-box; }
        
        .grid-checks { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 10px 0; }
        .check-item { background: #fff; border: 1px solid #e2e8f0; padding: 10px; border-radius: 10px; font-size: 14px; display: flex; align-items: center; gap: 8px; cursor: pointer; }
        
        .list-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px; background: white; margin-bottom: 8px; border-radius: 10px; border-right: 4px solid var(--accent);
        }
        .status-badge { font-size: 11px; padding: 2px 8px; border-radius: 10px; background: #e2e8f0; }
    </style>
</head>

<body>
<div class="app-container">
    <header>
        <b>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© v2026</b>
        <div id="status" style="font-size:12px; color:#94a3b8; margin-top:5px;">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</div>
    </header>

    <div class="tabs-nav">
        <button class="tab-btn active" onclick="openTab(event,'teachers')">ğŸ‘¨â€ğŸ« Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</button>
        <button class="tab-btn" onclick="openTab(event,'control')">ğŸ”“ Ø§Ù„Ø£Ù‚ÙØ§Ù„</button>
        <button class="tab-btn" onclick="openTab(event,'reset')">ğŸ§¹ Ø§Ù„ØªØµÙÙŠØ±/ØªØµØ¯ÙŠØ±</button>
    </div>

    <div class="content-area">
        
        <div id="teachers" class="tab-panel active">
            <div class="card">
                <h4 style="margin-top:0;">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„Ù… Ø¬Ø¯ÙŠØ¯</h4>
                <input type="text" id="newTName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„">
                <input type="text" id="newTSubject" placeholder="Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©">
                <button class="btn-main" style="background:var(--success)" onclick="addTeacher()">Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            </div>
            <div id="teacherCards">
                </div>
        </div>

        <div id="control" class="tab-panel">
            <div class="card">
                <h4>ğŸ”“ ÙØªØ­ ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹</h4>
                <p style="font-size:12px; color:gray;">Ø§Ù„ØªØºÙŠÙŠØ± ÙŠØªÙ… ÙÙˆØ±Ø§Ù‹ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø·Ø§Ù„Ø¨</p>
                <div id="weeksLock" class="grid-checks"></div>
            </div>

            <div class="card">
                <h4>ğŸ“… Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</h4>
                <label>Ø§Ø®ØªØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹:</label>
                <select id="examWeek">
                    <option value="w1">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 1</option>
                    <option value="w2">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 2</option>
                    <option value="w3">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 3</option>
                </select>
                <label>ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</label>
                <input type="datetime-local" id="examDate">
                <button class="btn-main" style="background:var(--accent)" onclick="scheduleExam()">ØªØ­Ø¯ÙŠØ« Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
            </div>
        </div>

        <div id="reset" class="tab-panel">
            <div class="card" style="border-right: 5px solid var(--danger);">
                <h4>ğŸ§¹ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªØµÙÙŠØ± (Ø®Ø·Ø±)</h4>
                <select id="resT" onchange="loadResetOptions()">
                    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØµÙÙŠØ±Ù‡ --</option>
                </select>
                <div id="resW" class="grid-checks"></div>
                <button class="btn-main" style="background:var(--danger)" onclick="executeSafeReset()">ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</button>
            </div>

            <div class="card">
                <h4>ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h4>
                <button class="btn-main" style="background:var(--primary)" onclick="runExport()">ØªØ­Ù…ÙŠÙ„ ÙƒÙ…Ù„Ù Excel</button>
            </div>
        </div>

    </div>
</div>

<script>
    // ØªÙ‡ÙŠØ¦Ø© ÙØ§ÙŠØ±Ø¨ÙŠØ²
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let teachers = [];
    let students = [];
    let weeksStatus = {};

    // 1. Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
    async function init() {
        updateStatus("â³ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...");
        try {
            // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† (Ù‚Ø±Ø§Ø¡Ø© Ø­Ù‚ÙŠÙ‚ÙŠØ©)
            const tSnap = await db.collection('teachers').get();
            teachers = tSnap.docs.map(d => ({ id: d.id, ...d.data() }));

            // Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø§Ø¨
            const sSnap = await db.collection('students').get();
            students = sSnap.docs.map(d => ({ id: d.id, ...d.data() }));

            // Ø¬Ù„Ø¨ Ø§Ù„Ø£Ù‚ÙØ§Ù„
            const lockDoc = await db.collection('settings').doc('weeks_control').get();
            weeksStatus = lockDoc.exists ? lockDoc.data() : {};

            renderTeachers();
            renderLocks();
            loadResetOptions();
            updateStatus("âœ… Ù…ØªØµÙ„ ÙˆÙ‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„");
        } catch (e) {
            console.error(e);
            updateStatus("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©");
        }
    }

    function updateStatus(msg) {
        document.getElementById('status').innerText = msg;
    }

    // 2. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†
    function renderTeachers() {
        const tDiv = document.getElementById('teacherCards');
        const resT = document.getElementById('resT');
        
        tDiv.innerHTML = '<h4>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</h4>';
        resT.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¹Ù„Ù… --</option>';

        teachers.forEach(t => {
            // Ø¥Ø¶Ø§ÙØ© Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†
            tDiv.innerHTML += `
                <div class="list-item">
                    <div>
                        <b>${t.name}</b><br>
                        <small style="color:gray;">${t.subject || 'Ø¹Ø§Ù…'}</small>
                    </div>
                    <button onclick="deleteTeacher('${t.id}')" style="color:var(--danger); background:none; border:none; cursor:pointer; font-weight:bold;">Ø­Ø°Ù</button>
                </div>
            `;
            // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© ÙÙŠ Ø§Ù„ØªØµÙÙŠØ±
            resT.innerHTML += `<option value="${t.id}">${t.name}</option>`;
        });
    }

    async function addTeacher() {
        const name = document.getElementById('newTName').value;
        const subject = document.getElementById('newTSubject').value;
        if (!name) return alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…");

        updateStatus("â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...");
        await db.collection('teachers').add({ name, subject, createdAt: new Date() });
        document.getElementById('newTName').value = '';
        init(); // ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ
    }

    async function deleteTeacher(id) {
        if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ù„Ù… Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) {
            await db.collection('teachers').doc(id).delete();
            init();
        }
    }

    // 3. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚ÙØ§Ù„
    function renderLocks() {
        const container = document.getElementById('weeksLock');
        container.innerHTML = '';
        for (let i = 1; i <= 14; i++) {
            const key = `w${i}`;
            const isChecked = weeksStatus[key] ? 'checked' : '';
            container.innerHTML += `
                <label class="check-item">
                    <input type="checkbox" onchange="updateLock('${key}', this.checked)" ${isChecked}> Ø£Ø³Ø¨ÙˆØ¹ ${i}
                </label>
            `;
        }
    }

    async function updateLock(key, val) {
        updateStatus("â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ù‚ÙØ§Ù„...");
        await db.collection('settings').doc('weeks_control').set({ [key]: val }, { merge: true });
        updateStatus("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸");
    }

    // 4. Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
    async function scheduleExam() {
        const week = document.getElementById('examWeek').value;
        const date = document.getElementById('examDate').value;
        if (!date) return alert("Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ®Ø§Ù‹");

        await db.collection('settings').doc('exams_schedule').set({
            [week]: date
        }, { merge: true });
        alert("ØªÙ…Øª Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­");
    }

    // 5. ØªØµÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    function loadResetOptions() {
        const container = document.getElementById('resW');
        container.innerHTML = '';
        for (let i = 1; i <= 14; i++) {
            container.innerHTML += `
                <label class="check-item" style="font-size:12px;">
                    <input type="checkbox" name="resetW" value="w${i}"> Ø£Ø³Ø¨ÙˆØ¹ ${i}
                </label>`;
        }
    }

    async function executeSafeReset() {
        const teacherId = document.getElementById('resT').value;
        const checkedWeeks = Array.from(document.querySelectorAll('input[name="resetW"]:checked')).map(el => el.value);

        if (!teacherId || checkedWeeks.length === 0) return alert("Ø­Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù… ÙˆØ§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø£ÙˆÙ„Ø§Ù‹");

        if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø¯Ø±Ø¬Ø§Øª ÙƒØ§ÙØ© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø±ØªØ¨Ø·ÙŠÙ† Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ù„Ù… Ù„Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©!")) {
            updateStatus("â³ Ø¬Ø§Ø±ÙŠ Ù…Ø³Ø­ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª...");
            const batch = db.batch();
            
            // ÙÙ„ØªØ±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„ØªØ§Ø¨Ø¹ÙŠÙ† Ù„Ù„Ù…Ø¹Ù„Ù… (Ø£Ùˆ ÙƒÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø±Ø¨Ø·Ù‡Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹)
            students.forEach(s => {
                const sRef = db.collection('students').doc(s.id);
                let updates = {};
                checkedWeeks.forEach(w => {
                    updates[w] = firebase.firestore.FieldValue.delete(); // Ø­Ø°Ù Ø§Ù„Ø­Ù‚Ù„ (Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹) Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø³Ø¬Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨
                });
                batch.update(sRef, updates);
            });

            await batch.commit();
            alert("ØªÙ… Ø§Ù„ØªØµÙÙŠØ± Ø¨Ù†Ø¬Ø§Ø­");
            init();
        }
    }

    // 6. ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³Ù„
    function runExport() {
        if (students.length === 0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø§Ø¨ Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§");
        
        const exportData = students.map(s => ({
            "Ø§Ù„Ø§Ø³Ù…": s.name,
            "Ø§Ù„ÙƒÙˆØ¯": s.code || 'N/A',
            "Ø§Ù„ØµÙ": s.grade || '',
            "Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©": s.totalScore || 0
        }));

        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Ù†ØªØ§Ø¦Ø¬_Ø§Ù„Ø·Ù„Ø§Ø¨");
        XLSX.writeFile(wb, `Ø±ØµØ¯_Ø·Ù„Ø§Ø¨_${new Date().toLocaleDateString()}.xlsx`);
    }

    // Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
    function openTab(evt, id) {
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        evt.currentTarget.classList.add('active');
    }

    window.onload = init;
</script>
</body>
</html>
