<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… | Ø§Ù„Ø£Ø³ØªØ§Ø° Ù…Ø­Ù…ÙˆØ¯ Ø¹Ø§Ø¯Ù„</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { --admin: #8e44ad; --teacher: #16a085; --dark: #2c3e50; --accent: #e67e22; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 0; direction: rtl; }
        .nav { background: var(--dark); color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2); position: sticky; top: 0; z-index: 1000; }
        .container { padding: 25px; max-width: 1500px; margin: auto; }
        .card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; border: 1px solid #e0e0e0; }
        .admin-only { display: none; border-right: 8px solid var(--admin); background: #fdfaff; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        select, input, textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 10px; font-size: 15px; box-sizing: border-box; }
        .btn { padding: 12px 20px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; color: white; transition: 0.3s; }
        .btn-admin { background: var(--admin); }
        .btn-teacher { background: var(--teacher); }
        .btn-save { background: var(--accent); animation: pulse 2s infinite; }
        .btn-danger { background: #e74c3c; }
        @keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(230, 126, 34, 0.4);} 70% {box-shadow: 0 0 0 10px rgba(230, 126, 34, 0);} 100% {box-shadow: 0 0 0 0 rgba(230, 126, 34, 0);} }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th { background: var(--dark); color: white; padding: 15px; }
        td { padding: 12px; border: 1px solid #f0f0f0; text-align: center; font-weight: 600; }
        .score-input { width: 65px; padding: 8px; text-align: center; border: 2px solid #ddd; border-radius: 8px; }
        .pending-save { background-color: #fff3cd !important; border-color: #ffc107 !important; }
        #notif-bar { background: #fff3cd; color: #856404; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: none; font-weight: bold; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="nav">
    <div><span id="u-name">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span> <span id="u-role" style="font-size: 12px; opacity: 0.8;"></span></div>
    <div style="display:flex; gap:10px;">
        <button id="manualSaveBtn" onclick="forceSave()" class="btn btn-save">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø¢Ù† (0)</button>
        <button onclick="logout()" class="btn btn-danger">Ø®Ø±ÙˆØ¬</button>
    </div>
</div>

<div class="container">
    <div id="notif-bar"></div>

    <div id="admin-panel" class="card admin-only">
        <h3 style="color:var(--admin); margin-top:0;">ğŸ›  Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ±</h3>
        <div class="grid">
            <div>
                <label>Ø±ÙØ¹ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨:</label>
                <select id="up-grade" onchange="toggleBranch('up-branch-div', this.value)">
                    <option value="1">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                    <option value="2">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                </select>
                <div id="up-branch-div" class="hidden" style="margin-top:10px;">
                    <select id="up-branch"><option value="scientific">Ø¹Ù„Ù…ÙŠ</option><option value="literary">Ø£Ø¯Ø¨ÙŠ</option></select>
                </div>
                <textarea id="up-names" placeholder="Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ù‡Ù†Ø§ (Ø§Ø³Ù… ÙÙŠ ÙƒÙ„ Ø³Ø·Ø±)"></textarea>
                <button onclick="uploadAction()" class="btn btn-admin" style="width:100%; margin-top:10px;">Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø§Ø¨</button>
            </div>
            <div>
                <label>Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„Ù…:</label>
                <input type="text" id="t-name" placeholder="Ø§Ù„Ø§Ø³Ù…">
                <input type="text" id="t-sub" placeholder="Ø§Ù„Ù…Ø§Ø¯Ø©" style="margin-top:5px;">
                <input type="email" id="t-email" placeholder="Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„" style="margin-top:5px;">
                <input type="text" id="t-pass" placeholder="Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯" style="margin-top:5px;">
                <button onclick="addTeacherAction()" class="btn btn-admin" style="width:100%; margin-top:10px;">Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù…</button>
            </div>
            <div>
                <label>ØªØ­ÙƒÙ… Ø§Ù„Ù†Ø¸Ø§Ù…:</label>
                <select id="lock-sys" onchange="setLock(this.value)">
                    <option value="false">Ø§Ù„Ø±ØµØ¯ Ù…ÙØªÙˆØ­</option>
                    <option value="true">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø±ØµØ¯</option>
                </select>
                <button onclick="exportExcel()" class="btn" style="background:#27ae60; width:100%; margin-top:15px;">ØªØµØ¯ÙŠØ± Excel</button>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; align-items: end;">
            <div>
                <label>Ø§Ù„ØµÙ:</label>
                <select id="v-grade" onchange="toggleBranch('v-branch-div', this.value); fetchStudents()">
                    <option value="1">Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                    <option value="2">Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                </select>
            </div>
            <div id="v-branch-div" class="hidden"><select id="v-branch" onchange="fetchStudents()"><option value="scientific">Ø¹Ù„Ù…ÙŠ</option><option value="literary">Ø£Ø¯Ø¨ÙŠ</option></select></div>
            <div><label>Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹:</label><select id="v-week" onchange="loadGrades()"></select></div>
        </div>

        <div id="sync-status" style="margin-top:15px; font-size:14px; color:#666;">Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: Ù…Ø³ØªÙ‚Ø±</div>

        <div style="margin-top:15px; display:flex; gap:10px;">
            <button onclick="applyAll('t', 15)" class="btn btn-teacher">ØªØ·Ø¨ÙŠÙ‚ Ø¯Ø±Ø¬Ø© Ù„Ù„ÙƒÙ„ (ØªÙ‚ÙŠÙŠÙ…)</button>
            <button onclick="applyAll('v', 15)" class="btn btn-teacher">ØªØ·Ø¨ÙŠÙ‚ Ø¯Ø±Ø¬Ø© Ù„Ù„ÙƒÙ„ (Ø­ØµØ©)</button>
        </div>

        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr><th>Ù…</th><th style="text-align:right">Ø§Ù„Ø§Ø³Ù…</th><th>ØªÙ‚ÙŠÙŠÙ… (15)</th><th class="extra">Ø­ØµØ© (15)</th><th class="extra">Ø³Ù„ÙˆÙƒ (10)</th></tr>
                </thead>
                <tbody id="s-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyBePGZiqMPmZQdg36jZ4Rkdtd7OISxmob8", projectId: "rasd-tools" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const isAdmin = sessionStorage.getItem('isAdmin') === 'true';
    const userEmail = sessionStorage.getItem('userEmail');
    const userName = sessionStorage.getItem('userName');

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© (Buffer) ---
    let pendingChanges = {}; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸
    let changeCount = 0;
    let autoSaveTimer = null;

    const WEEKS = [
        {id:'w1', n:'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 1'}, {id:'w2', n:'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 2'}, {id:'w3', n:'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 3'}, {id:'w4', n:'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 4'}, {id:'w5', n:'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 5'}, {id:'w6', n:'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 6'},
        {id:'ex1', n:'Ø§Ø®ØªØ¨Ø§Ø± 1', isEx:true},
        {id:'w7', n:'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 7'}, {id:'w8', n:'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 8'}, {id:'w9', n:'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 9'}, {id:'w10', n:'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 10'},
        {id:'ex2', n:'Ø§Ø®ØªØ¨Ø§Ø± 2', isEx:true},
        {id:'w11', n:'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 11'}, {id:'w12', n:'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 12'}, {id:'w13', n:'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 13'}, {id:'w14', n:'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 14'}
    ];

    window.onload = () => {
        if(!userName) { window.location.href="index.html"; return; }
        document.getElementById('u-name').innerText = userName;
        document.getElementById('u-role').innerText = isAdmin ? "(Ù…Ø¯ÙŠØ±)" : "(Ù…Ø¹Ù„Ù…)";
        if(isAdmin) document.getElementById('admin-panel').style.display = 'block';
        document.getElementById('v-week').innerHTML = WEEKS.map(w => `<option value="${w.id}">${w.n}</option>`).join('');
        fetchStudents();
        startAutoSaveTimer();
    };

    function toggleBranch(id, v) { document.getElementById(id).className = (v==="2") ? "" : "hidden"; }

    async function fetchStudents() {
        const g = document.getElementById('v-grade').value.toString();
        const b = (g === "1") ? "general" : document.getElementById('v-branch').value;
        const snap = await db.collection('students').where('grade', '==', g).where('branch', '==', b).get();
        const tbody = document.getElementById('s-body');
        tbody.innerHTML = '';
        let i = 1;
        snap.forEach(doc => {
            const s = doc.data();
            tbody.innerHTML += `<tr>
                <td>${i++}</td>
                <td style="text-align:right">${s.name}</td>
                <td><input type="number" class="score-input" oninput="queueChange('${doc.id}','t',this,15)" data-sid="${doc.id}" data-type="t"></td>
                <td class="extra"><input type="number" class="score-input" oninput="queueChange('${doc.id}','v',this,15)" data-sid="${doc.id}" data-type="v"></td>
                <td class="extra"><input type="number" class="score-input" oninput="queueChange('${doc.id}','s',this,10)" data-sid="${doc.id}" data-type="s"></td>
            </tr>`;
        });
        loadGrades();
    }

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØºÙŠÙŠØ± Ù„Ù„Ø·Ø§Ø¨ÙˆØ±
    function queueChange(sid, type, input, max) {
        let val = parseFloat(input.value);
        if(val > max) { alert("ØªØ¬Ø§ÙˆØ²Øª Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰!"); input.value = ""; return; }
        
        const week = document.getElementById('v-week').value;
        const key = `${sid}_${week}_${type}`;
        
        pendingChanges[key] = { sid, week, type, score: val, lastUpdate: new Date() };
        input.classList.add('pending-save');
        
        changeCount = Object.keys(pendingChanges).length;
        document.getElementById('manualSaveBtn').innerText = `Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø¢Ù† (${changeCount})`;

        if(changeCount >= 20) forceSave();
    }

    // Ù…Ø­Ø±Ùƒ Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (ÙƒÙ„ 20 Ø«Ø§Ù†ÙŠØ©)
    function startAutoSaveTimer() {
        autoSaveTimer = setInterval(() => {
            if(changeCount > 0) {
                console.log("Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¯ÙˆØ±ÙŠ...");
                forceSave();
            }
        }, 20000);
    }

    async function forceSave() {
        if(changeCount === 0) return;
        
        const btn = document.getElementById('manualSaveBtn');
        btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸ Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø©...";
        btn.disabled = true;

        const batch = db.batch();
        for (const key in pendingChanges) {
            const ref = db.collection('grades').doc(key);
            batch.set(ref, pendingChanges[key], {merge:true});
        }

        try {
            await batch.commit();
            document.querySelectorAll('.pending-save').forEach(el => el.classList.remove('pending-save'));
            pendingChanges = {};
            changeCount = 0;
            btn.innerText = `Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø¢Ù† (0)`;
            btn.disabled = false;
            document.getElementById('sync-status').innerText = "ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ… " + new Date().toLocaleTimeString();
        } catch(e) {
            alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø©!");
            btn.disabled = false;
        }
    }

    async function loadGrades() {
        const week = document.getElementById('v-week').value;
        const isEx = WEEKS.find(w => w.id === week).isEx;
        document.querySelectorAll('.extra').forEach(e => e.style.display = isEx ? 'none' : 'table-cell');
        const snap = await db.collection('grades').where('week', '==', week).get();
        document.querySelectorAll('.score-input').forEach(i => i.value = '');
        snap.forEach(doc => {
            const g = doc.data();
            const input = document.querySelector(`input[data-sid="${g.sid}"][data-type="${g.type}"]`);
            if(input) { input.value = g.score; input.classList.remove('pending-save'); }
        });
    }

    async function applyAll(type, max) {
        const val = prompt(`Ø¯Ø±Ø¬Ø© Ù…ÙˆØ­Ø¯Ø© Ù„Ù€ ${type === 't' ? 'Ø§Ù„ØªÙ‚ÙŠÙŠÙ…' : 'Ø§Ù„Ø­ØµØ©'} (Ø¨Ø­Ø¯ Ø£Ù‚ØµÙ‰ ${max}):`);
        if(!val || parseFloat(val) > max) return;
        const inputs = document.querySelectorAll(`input[data-type="${type}"]`);
        inputs.forEach(i => {
            i.value = val;
            queueChange(i.getAttribute('data-sid'), type, i, max);
        });
    }

    // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø±ÙØ¹ ÙˆØ£Ø¯ÙˆØ§Øª)
    async function uploadAction() {
        const names = document.getElementById('up-names').value.split('\n').filter(n => n.trim() !== "");
        const g = document.getElementById('up-grade').value.toString();
        const b = (g === "1") ? "general" : document.getElementById('up-branch').value;
        const batch = db.batch();
        names.forEach(n => { const ref = db.collection('students').doc(); batch.set(ref, {name:n.trim(), grade:g, branch:b}); });
        await batch.commit();
        alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…");
        fetchStudents();
    }

    function logout() { sessionStorage.clear(); window.location.href="index.html"; }
</script>
</body>
</html>
