<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>منظومة الرصد - مركز قيادة الأستاذ محمود عادل</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --admin-main: #2c3e50; --admin-accent: #8e44ad; --teacher-accent: #1abc9c; --danger: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; direction: rtl; }
        .nav { background: var(--admin-main); color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .container { padding: 25px; max-width: 1500px; margin: auto; }
        .card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 25px rgba(0,0,0,0.05); margin-bottom: 25px; border-top: 4px solid var(--admin-accent); }
        .admin-section { display: none; background: #fdfaff; border: 1px solid #dcd0ff; }
        .grid-admin { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; border-radius: 10px; overflow: hidden; }
        th { background: var(--admin-main); color: white; padding: 15px; }
        td { padding: 12px; border: 1px solid #eee; text-align: center; font-weight: bold; }
        .btn { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .status-tag { padding: 4px 10px; border-radius: 20px; font-size: 12px; }
        .locked { background: #f8d7da; color: #721c24; pointer-events: none; opacity: 0.7; }
        .score-input { width: 60px; padding: 10px; text-align: center; border: 2px solid #ddd; border-radius: 8px; }
    </style>
</head>
<body>

<div class="nav">
    <div>
        <span id="welcome-msg" style="font-size: 1.2em; font-weight: 900;">تحكم المدير</span>
        <span id="lock-status" class="status-tag" style="margin-right:15px;"></span>
    </div>
    <button onclick="logout()" class="btn" style="background:var(--danger); color:white;">خروج آمن</button>
</div>

<div class="container">
    <div id="admin-master-panel" class="card admin-section">
        <h2 style="color:var(--admin-accent);">لوحة إدارة المنظومة (صلاحيات كاملة)</h2>
        <div class="grid-admin">
            <div style="background:white; padding:15px; border-radius:10px; border:1fr solid #eee;">
                <h4>إضافة/تعديل معلم</h4>
                <input type="email" id="newTeacherEmail" placeholder="إيميل المعلم" class="score-input" style="width:90%; margin-bottom:10px;">
                <input type="password" id="newTeacherPass" placeholder="كلمة المرور" class="score-input" style="width:90%; margin-bottom:10px;">
                <select id="teacherGrade" class="score-input" style="width:90%; margin-bottom:10px;">
                    <option value="1">الصف الأول</option>
                    <option value="2">الصف الثاني</option>
                    <option value="both">كلاهما</option>
                </select>
                <button onclick="createTeacherAccount()" class="btn" style="background:var(--admin-accent); color:white; width:95%;">تفعيل حساب المعلم</button>
            </div>

            <div style="background:white; padding:15px; border-radius:10px;">
                <h4>التحكم في فترة الرصد</h4>
                <p style="font-size:12px; color:#666;">اختر الأسابيع المسموح بتعديلها حالياً:</p>
                <select id="allowedWeeks" class="score-input" style="width:90%;" onchange="toggleLockingSystem(this.value)">
                    <option value="all">فتح كافة الأسابيع</option>
                    <option value="current">الأسبوع الحالي فقط</option>
                    <option value="none">إغلاق الرصد نهائياً</option>
                </select>
                <hr>
                <button onclick="exportFullData()" class="btn" style="background:#27ae60; color:white; width:95%;">تحميل الشيت السحابي الموحد</button>
            </div>

            <div style="background:white; padding:15px; border-radius:10px;">
                <h4>رفع أسماء دفعة جديدة</h4>
                <textarea id="rawNames" style="width:90%; height:80px; padding:10px; border-radius:8px;" placeholder="اسم في كل سطر..."></textarea>
                <button onclick="bulkUpload()" class="btn" style="background:var(--admin-main); color:white; width:95%; margin-top:5px;">بدء الرفع</button>
            </div>
        </div>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>سجل الرصد</h3>
            <div>
                <select id="gradeFilter" class="score-input" style="width:180px;" onchange="loadStudents()">
                    <option value="1">الصف الأول</option>
                    <option value="2">الصف الثاني</option>
                </select>
                <select id="weekPicker" class="score-input" style="width:180px;" onchange="syncGrades()"></select>
            </div>
        </div>
        <div id="status-msg" style="padding:10px; color:#2980b9; font-weight:bold;"></div>
        
        <table id="main-table">
            <thead>
                <tr>
                    <th>م</th>
                    <th style="width:300px;">اسم الطالب</th>
                    <th>التقييم (15)</th>
                    <th class="normal-only">الحصة (15)</th>
                    <th class="normal-only">السلوك (10)</th>
                </tr>
            </thead>
            <tbody id="students-body"></tbody>
        </table>
    </div>
</div>

<script>
    // الإعدادات الخاصة بك
    const firebaseConfig = {
      apiKey: "AIzaSyBePGZiqMPmZQdg36jZ4Rkdtd7OISxmob8",
      authDomain: "rasd-tools.firebaseapp.com",
      projectId: "rasd-tools",
      storageBucket: "rasd-tools.firebasestorage.app",
      messagingSenderId: "1048930814102",
      appId: "1:1048930814102:web:6382a0efde498149281ab7",
      measurementId: "G-YJFDM9699T"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const isAdmin = sessionStorage.getItem('isAdmin') === 'true';
    const userName = sessionStorage.getItem('userName');
    let isEditingLocked = false;

    window.onload = async () => {
        if(isAdmin) document.getElementById('admin-master-panel').style.display = 'block';
        document.getElementById('welcome-msg').innerText = "مرحباً: " + userName;
        
        // تحميل إعدادات القفل من السحابة
        const sysLock = await db.collection('settings').doc('lockSystem').get();
        if(sysLock.exists) applyLockingUI(sysLock.data().mode);

        initWeekPicker();
        loadStudents();
    };

    // وظيفة التحكم في القفل (للمدير)
    async function toggleLockingSystem(mode) {
        await db.collection('settings').doc('lockSystem').set({ mode: mode });
        location.reload(); // تحديث لتطبيق القفل
    }

    function applyLockingUI(mode) {
        const badge = document.getElementById('lock-status');
        if(mode === 'none' && !isAdmin) {
            isEditingLocked = true;
            badge.innerText = "الرصد مغلق حالياً";
            badge.style.background = "#e74c3c";
            document.getElementById('main-table').classList.add('locked');
        } else {
            badge.innerText = "الرصد مفتوح";
            badge.style.background = "#2ecc71";
        }
    }

    // إضافة معلم جديد (سحابياً)
    async function createTeacherAccount() {
        const email = document.getElementById('newTeacherEmail').value;
        const pass = document.getElementById('newTeacherPass').value;
        const grade = document.getElementById('teacherGrade').value;

        if(!email || !pass) return alert("أدخل الإيميل والباسورد");

        await db.collection('users').doc(email).set({
            email: email,
            password: pass, // للتخزين كمرجع للمدير
            assignedGrade: grade,
            role: 'teacher',
            status: 'active'
        });
        alert("تم إنشاء حساب المعلم بنجاح ✅");
    }

    async function loadStudents() {
        const grade = document.getElementById('gradeFilter').value;
        const snap = await db.collection('students').where('grade', '==', grade).orderBy('name').get();
        const tbody = document.getElementById('students-body');
        tbody.innerHTML = '';
        
        snap.forEach((doc, i) => {
            tbody.innerHTML += `<tr>
                <td>${i+1}</td>
                <td style="text-align:right">${doc.data().name}</td>
                <td><input type="number" class="score-input" onchange="save('${doc.id}','t',this.value)" data-sid="${doc.id}" data-type="t"></td>
                <td class="normal-only"><input type="number" class="score-input" onchange="save('${doc.id}','v',this.value)" data-sid="${doc.id}" data-type="v"></td>
                <td class="normal-only"><input type="number" class="score-input" onchange="save('${doc.id}','s',this.value)" data-sid="${doc.id}" data-type="s"></td>
            </tr>`;
        });
        syncGrades();
    }

    async function save(sid, type, val) {
        if(isEditingLocked && !isAdmin) return alert("عذراً، التعديل مغلق بأمر المدير");
        
        const week = document.getElementById('weekPicker').value;
        await db.collection('grades').doc(`${sid}_${week}_${type}`).set({
            studentId: sid,
            weekId: week,
            type: type,
            score: parseFloat(val),
            lastUpdate: new Date()
        }, {merge: true});
        document.getElementById('status-msg').innerText = "تم الحفظ سحابياً ✅";
    }

    // بقية الوظائف (Bulk Upload, Export, Init) يتم دمجها كما في الأكواد السابقة
    function initWeekPicker() {
        const weeks = ["الأسبوع 1", "الأسبوع 2", "الأسبوع 3", "الأسبوع 4", "الأسبوع 5", "الأسبوع 6", "اختبار 1", "الأسبوع 7", "الأسبوع 8", "الأسبوع 9", "الأسبوع 10", "اختبار 2", "الأسبوع 11", "الأسبوع 12", "الأسبوع 13", "الأسبوع 14"];
        document.getElementById('weekPicker').innerHTML = weeks.map((w, i) => `<option value="w${i+1}">${w}</option>`).join('');
    }

    async function syncGrades() {
        const week = document.getElementById('weekPicker').value;
        const snap = await db.collection('grades').where('weekId', '==', week).get();
        document.querySelectorAll('.score-input').forEach(i => i.value = '');
        snap.forEach(doc => {
            const g = doc.data();
            const input = document.querySelector(`input[data-sid="${g.studentId}"][data-type="${g.type}"]`);
            if(input) input.value = g.score;
        });
    }

    function logout() { sessionStorage.clear(); window.location.href = "index.html"; }
</script>
</body>
</html>
