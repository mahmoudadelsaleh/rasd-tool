<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù…Ù†Ø¸ÙˆÙ…Ø© Ù…Ø­Ù…ÙˆØ¯ Ø¹Ø§Ø¯Ù„ | Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --admin: #2c3e50; --primary: #27ae60; --accent: #e67e22; --danger: #e74c3c; --info: #3498db; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f4f7f6; margin: 0; direction: rtl; }
        .nav { background: var(--admin); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        .container { padding: 20px; max-width: 1500px; margin: auto; }
        .card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        
        /* Ø¶Ø¨Ø· Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ù„Ø®Ø§Ù†Ø§Øª */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
        th, td { padding: 12px; border: 1px solid #eee; text-align: center; vertical-align: middle; }
        th { background: #f8f9fa; position: sticky; top: 60px; z-index: 10; }
        .in-score { width: 70px; padding: 8px; border: 2px solid #ddd; border-radius: 6px; text-align: center; font-weight: bold; }
        
        /* Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… */
        .week-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; background: #f9f9f9; padding: 10px; border-radius: 10px; }
        .week-item { font-size: 11px; text-align: center; border: 1px solid #ddd; padding: 5px; border-radius: 5px; }
        .smart-box { background: #eef2f7; padding: 15px; border-radius: 10px; border-right: 5px solid var(--info); }
        
        .btn { padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: bold; transition: 0.3s; }
        .btn-save { background: var(--primary); }
        .btn-del { background: var(--danger); }
        .hidden { display: none; }
        .lock-banner { background: #fee2e2; color: #b91c1c; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-weight: bold; text-align: center; }
    </style>
</head>
<body>

<div class="nav">
    <div><b>Ù…Ù†Ø¸ÙˆÙ…Ø© Ø£/ Ù…Ø­Ù…ÙˆØ¯ Ø¹Ø§Ø¯Ù„ | <span id="displayUserName">...</span></b></div>
    <button onclick="logout()" class="btn btn-del">Ø®Ø±ÙˆØ¬</button>
</div>

<div class="container">
    
    <div id="adminPanel" class="card hidden">
        <h3>ğŸ›  Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø°ÙƒÙŠØ© ÙˆØ§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø²Ù…Ù†</h3>
        <div class="grid">
            
            <div class="smart-box">
                <h4>ğŸ“… ØºÙ„Ù‚ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</h4>
                <div class="week-grid" id="weekLocksContainer">
                    </div>
                <div style="margin-top:10px;">
                    <label>ØªØ­ÙˆÙŠÙ„ Ø£Ø³Ø¨ÙˆØ¹ Ø¥Ù„Ù‰ Ø§Ø®ØªØ¨Ø§Ø±:</label>
                    <select id="examWeekSelect" onchange="updateExamSettings()">
                        <option value="none">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø± Ø­Ø§Ù„ÙŠØ§Ù‹</option>
                    </select>
                </div>
            </div>

            <div class="smart-box">
                <h4>ğŸ¤– Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø°ÙƒÙŠ</h4>
                <label><input type="checkbox" id="smartTimerToggle" onchange="updateSmartSettings()"> ØªÙØ¹ÙŠÙ„ "Ø¹Ø¯Ù… Ø§Ø³ØªØ¨Ø§Ù‚ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«"</label>
                <div id="smartTimerOptions" style="margin-top:10px;" class="hidden">
                    <label>ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø©:</label>
                    <input type="date" id="startDate" onchange="updateSmartSettings()">
                    <p style="font-size: 11px; color: #666;">* Ø³ÙŠØªÙ… ÙØªØ­ Ø£Ø³Ø¨ÙˆØ¹ Ø¬Ø¯ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙƒÙ„ 7 Ø£ÙŠØ§Ù… Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ®.</p>
                </div>
            </div>

            <div class="smart-box">
                <h4>ğŸ‘¥ Ø§Ù„Ù…Ø¹Ù„Ù…ÙˆÙ† ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h4>
                <input type="text" id="t-id" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ù…Ø¹Ù„Ù…">
                <input type="text" id="t-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…">
                <button onclick="addTeacher()" class="btn btn-save" style="width:100%; margin-top:5px;">Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„Ù…</button>
                <hr>
                <textarea id="namesInput" placeholder="Ø§Ù„ØµÙ‚ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù„Ù„Ø±ÙØ¹..." style="height: 50px;"></textarea>
                <button onclick="importStudents()" class="btn" style="background:var(--accent); width:100%">ØªØ«Ø¨ÙŠØª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
            </div>

        </div>
    </div>

    <div class="card">
        <div id="statusBanner" class="lock-banner hidden">ğŸ”’ Ø§Ù„Ø±ØµØ¯ Ù…ØºÙ„Ù‚ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø¨Ù‚Ø±Ø§Ø± Ø¥Ø¯Ø§Ø±ÙŠ Ø£Ùˆ Ø²Ù…Ù†ÙŠ</div>
        
        <div class="grid" style="grid-template-columns: 2fr 1fr 1fr; align-items: end;">
            <div><label>Ø§Ù„ØµÙ:</label><select id="viewGrade" onchange="loadTable()"></select></div>
            <div><label>Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹:</label><select id="viewWeek" onchange="loadTable()"></select></div>
            <button id="saveBtn" onclick="saveAll()" class="btn btn-save" style="width:100%">ğŸ’¾ Ø­ÙØ¸ (0)</button>
        </div>

        <div style="overflow-x: auto; padding-top: 10px;">
            <table>
                <thead>
                    <tr id="tableHeader">
                        </tr>
                </thead>
                <tbody id="mainTbody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyBePGZiqMPmZQdg36jZ4Rkdtd7OISxmob8", projectId: "rasd-tools" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const isAdmin = sessionStorage.getItem('isAdmin') === 'true';
    const userEmail = sessionStorage.getItem('userEmail');
    let sysData = { lockedWeeks: [], exams: [], smartActive: false, startDate: "" };
    let pending = {};

    window.onload = async () => {
        if(!userEmail) window.location.href="index.html";
        document.getElementById('displayUserName').innerText = sessionStorage.getItem('userName');
        
        initWeekControls();
        await fetchSettings();
        
        if(isAdmin) {
            document.getElementById('adminPanel').classList.remove('hidden');
            document.getElementById('viewGrade').innerHTML = `<option value="1_general">1Ø«</option><option value="2_scientific">2Ø« Ø¹Ù„Ù…ÙŠ</option><option value="2_literary">2Ø« Ø£Ø¯Ø¨ÙŠ</option>`;
        } else {
            await loadTeacherClasses();
        }
        loadTable();
    };

    function initWeekControls() {
        let html = '';
        let opt = '<option value="none">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø±</option>';
        for(let i=1; i<=14; i++) {
            html += `<div class="week-item"><input type="checkbox" class="week-lock-check" value="w${i}" onchange="updateLocks()"> <br> Ø£ ${i}</div>`;
            opt += `<option value="w${i}">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${i} (Ø§Ø®ØªØ¨Ø§Ø±)</option>`;
            document.getElementById('viewWeek').innerHTML += `<option value="w${i}">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${i}</option>`;
        }
        document.getElementById('weekLocksContainer').innerHTML = html;
        document.getElementById('examWeekSelect').innerHTML = opt;
    }

    async function fetchSettings() {
        const doc = await db.collection('settings').doc('global').get();
        if(doc.exists) {
            sysData = doc.data();
            // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¯ÙŠØ±
            sysData.lockedWeeks.forEach(w => {
                const chk = document.querySelector(`.week-lock-check[value="${w}"]`);
                if(chk) chk.checked = true;
            });
            document.getElementById('examWeekSelect').value = sysData.exams[0] || 'none';
            document.getElementById('smartTimerToggle').checked = sysData.smartActive;
            document.getElementById('startDate').value = sysData.startDate;
            if(sysData.smartActive) document.getElementById('smartTimerOptions').classList.remove('hidden');
        }
    }

    async function updateLocks() {
        sysData.lockedWeeks = Array.from(document.querySelectorAll('.week-lock-check:checked')).map(c => c.value);
        saveSettings();
    }

    async function updateExamSettings() {
        const val = document.getElementById('examWeekSelect').value;
        sysData.exams = val === 'none' ? [] : [val];
        saveSettings();
    }

    async function updateSmartSettings() {
        sysData.smartActive = document.getElementById('smartTimerToggle').checked;
        sysData.startDate = document.getElementById('startDate').value;
        document.getElementById('smartTimerOptions').classList.toggle('hidden', !sysData.smartActive);
        saveSettings();
    }

    async function saveSettings() {
        await db.collection('settings').doc('global').set(sysData, {merge:true});
        loadTable();
    }

    // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø°ÙƒÙŠØ© ---
    function isWeekAutoLocked(weekId) {
        if(!sysData.smartActive || !sysData.startDate) return false;
        const weekNum = parseInt(weekId.replace('w',''));
        const start = new Date(sysData.startDate);
        const today = new Date();
        const diffDays = Math.floor((today - start) / (1000 * 60 * 60 * 24));
        const currentAllowedWeek = Math.floor(diffDays / 7) + 1;
        return weekNum > currentAllowedWeek;
    }

    async function loadTable() {
        const week = document.getElementById('viewWeek').value;
        const isExam = sysData.exams.includes(week);
        const isLocked = !isAdmin && (sysData.lockedWeeks.includes(week) || isWeekAutoLocked(week));
        
        document.getElementById('statusBanner').classList.toggle('hidden', !isLocked);

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‡ÙŠØ¯Ø±
        const header = document.getElementById('tableHeader');
        if(isExam) {
            header.innerHTML = `<th>Ù…</th><th style="text-align:right">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th><th colspan="3">Ø¯Ø±Ø¬Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„</th>`;
        } else {
            header.innerHTML = `<th>Ù…</th><th style="text-align:right">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>ØªÙ‚ÙŠÙŠÙ… (15)</th><th>Ø­ØµØ© (15)</th><th>Ø³Ù„ÙˆÙƒ (10)</th>`;
        }

        const [g, b] = document.getElementById('viewGrade').value.split('_');
        const snap = await db.collection('students').where('grade','==',g).where('branch','==',b).get();
        let students = [];
        snap.forEach(d => students.push({id:d.id, ...d.data()}));
        students.sort((a,b) => (a.sortOrder || 0) - (b.sortOrder || 0));

        const tbody = document.getElementById('mainTbody');
        tbody.innerHTML = '';
        students.forEach((s, i) => {
            let row = `<td>${i+1}</td><td style="text-align:right">${s.name}</td>`;
            if(isExam) {
                row += `<td colspan="3"><input type="number" class="in-score" style="width:200px" oninput="queue('${s.id}','ex',this,100)" data-sid="${s.id}" data-type="ex" ${isLocked ? 'disabled' : ''}></td>`;
            } else {
                row += `<td><input type="number" class="in-score" oninput="queue('${s.id}','t',this,15)" data-sid="${s.id}" data-type="t" ${isLocked ? 'disabled' : ''}></td>
                        <td><input type="number" class="in-score" oninput="queue('${s.id}','v',this,15)" data-sid="${s.id}" data-type="v" ${isLocked ? 'disabled' : ''}></td>
                        <td><input type="number" class="in-score" oninput="queue('${s.id}','s',this,10)" data-sid="${s.id}" data-type="s" ${isLocked ? 'disabled' : ''}></td>`;
            }
            tbody.innerHTML += `<tr>${row}</tr>`;
        });
        fillSaved();
    }

    function queue(sid, type, input, max) {
        let v = parseFloat(input.value);
        if(v > max) { alert(`Ø§Ù„Ø£Ù‚ØµÙ‰ ${max}`); input.value=""; return; }
        const week = document.getElementById('viewWeek').value;
        pending[`${sid}_${week}_${type}`] = { sid, week, type, score: v, teacher: userEmail };
        input.style.borderColor = "var(--accent)";
        document.getElementById('saveBtn').innerText = `ğŸ’¾ Ø­ÙØ¸ (${Object.keys(pending).length})`;
    }

    async function saveAll() {
        const batch = db.batch();
        for(let k in pending) batch.set(db.collection('grades').doc(k), pending[k], {merge:true});
        await batch.commit();
        pending = {};
        document.getElementById('saveBtn').innerText = "ğŸ’¾ Ø­ÙØ¸ (0)";
        alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ âœ…"); loadTable();
    }

    async function fillSaved() {
        const week = document.getElementById('viewWeek').value;
        const snap = await db.collection('grades').where('week','==',week).get();
        snap.forEach(doc => {
            const d = doc.data();
            const input = document.querySelector(`input[data-sid="${d.sid}"][data-type="${d.type}"]`);
            if(input) { input.value = d.score; input.style.borderColor = "#ddd"; }
        });
    }

    // ÙˆØ¸Ø§Ø¦Ù Ø¥Ø¶Ø§ÙÙŠØ©
    async function importStudents() {
        const names = document.getElementById('namesInput').value.split('\n').filter(n => n.trim() !== "");
        const [g, b] = document.getElementById('viewGrade').value.split('_');
        const batch = db.batch();
        names.forEach((n, i) => batch.set(db.collection('students').doc(), {name:n.trim(), grade:g, branch:b, sortOrder:i}));
        await batch.commit(); alert("ØªÙ… Ø§Ù„Ø±ÙØ¹"); loadTable();
    }

    async function loadTeacherClasses() {
        const doc = await db.collection('teachers').doc(userEmail).get();
        if(doc.exists) document.getElementById('viewGrade').innerHTML = doc.data().classes.map(c => `<option value="${c}">${c}</option>`).join('');
    }

    function logout() { sessionStorage.clear(); window.location.href="index.html"; }
</script>
</body>
</html>
