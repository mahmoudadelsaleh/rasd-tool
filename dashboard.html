<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù…Ù†Ø¸ÙˆÙ…Ø© Ù…Ø­Ù…ÙˆØ¯ Ø¹Ø§Ø¯Ù„ | Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø³ØªÙ‚Ø±Ø© 2026</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --admin: #2c3e50; --primary: #27ae60; --accent: #e67e22; --danger: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 0; direction: rtl; }
        .nav { background: var(--admin); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .container { padding: 20px; max-width: 1400px; margin: auto; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ */
        .week-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 10px; }
        .week-item { background: #eee; padding: 5px; border-radius: 5px; text-align: center; font-size: 12px; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        th { background: #f8f9fa; position: sticky; top: 0; z-index: 100; }
        .in-score { width: 60px; padding: 8px; border: 2px solid #ccc; border-radius: 6px; text-align: center; }
        
        .btn { padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: bold; }
        .btn-save { background: var(--primary); }
        .btn-del { background: var(--danger); }
        .hidden { display: none !important; }
        .lock-banner { background: #ffebeb; color: #d63031; padding: 10px; border-radius: 8px; text-align: center; margin-bottom: 10px; border: 1px solid #fab1a0; }
    </style>
</head>
<body>

<div class="nav">
    <div><b>Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„Ø±ØµØ¯ | <span id="displayUserName">...</span></b></div>
    <button onclick="logout()" class="btn btn-del">Ø®Ø±ÙˆØ¬</button>
</div>

<div class="container">
    
    <div id="adminPanel" class="card hidden">
        <h3 style="color:var(--accent)">ğŸ›  Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
        <div class="grid">
            <div style="border-left: 2px solid #eee; padding-left: 10px;">
                <h4>ğŸ“… Ù‚ÙÙ„ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ ÙŠØ¯ÙˆÙŠØ§Ù‹</h4>
                <div class="week-grid" id="weekLocksContainer"></div>
                <hr>
                <h4>ğŸ† ØªØ¹ÙŠÙŠÙ† Ø£Ø³Ø¨ÙˆØ¹ ÙƒØ§Ø®ØªØ¨Ø§Ø±</h4>
                <select id="examWeekSelect" onchange="updateSettings()"><option value="none">Ù„Ø§ ÙŠÙˆØ¬Ø¯</option></select>
            </div>
            
            <div style="border-left: 2px solid #eee; padding-left: 10px;">
                <h4>ğŸ¤– Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø°ÙƒÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</h4>
                <label><input type="checkbox" id="smartActive" onchange="updateSettings()"> ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙˆÙ‚ÙŠØª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</label>
                <input type="date" id="startDate" onchange="updateSettings()" style="width: 100%; padding: 8px; margin-top: 10px;">
                <p style="font-size: 11px;">* Ø³ÙŠÙØªØ­ Ø£Ø³Ø¨ÙˆØ¹ Ø¬Ø¯ÙŠØ¯ ÙƒÙ„ 7 Ø£ÙŠØ§Ù… Ù…Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ø¯Ø¯.</p>
            </div>

            <div>
                <h4>ğŸ“¥ Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</h4>
                <input type="text" id="t-id" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ù…Ø¹Ù„Ù…" style="width:48%">
                <input type="text" id="t-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…" style="width:48%">
                <button onclick="addTeacher()" class="btn btn-save" style="width:100%; margin-top:5px;">Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„Ù…</button>
                <textarea id="namesInput" placeholder="Ø§Ù„ØµÙ‚ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ù‡Ù†Ø§..." style="width:100%; height:60px; margin-top:10px;"></textarea>
                <button onclick="importStudents()" class="btn" style="background:var(--accent); width:100%">Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨</button>
            </div>
        </div>
    </div>

    <div class="card">
        <div id="lockBanner" class="lock-banner hidden">ğŸ”’ Ø§Ù„Ø±ØµØ¯ Ù…ØºÙ„Ù‚ Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</div>
        <div class="grid" style="grid-template-columns: 2fr 1fr 1fr; align-items: end;">
            <div><label>Ø§Ù„ØµÙ:</label><select id="viewGrade" onchange="loadTable()"></select></div>
            <div><label>Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹:</label><select id="viewWeek" onchange="loadTable()"></select></div>
            <button id="saveBtn" onclick="saveData()" class="btn btn-save" style="width:100%">ğŸ’¾ Ø­ÙØ¸ (0)</button>
        </div>

        <div style="overflow-x: auto;">
            <table>
                <thead id="tableHeader"></thead>
                <tbody id="mainTbody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // ØªÙ‡ÙŠØ¦Ø© Firebase (ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù€ Config)
    const firebaseConfig = { apiKey: "AIzaSyBePGZiqMPmZQdg36jZ4Rkdtd7OISxmob8", projectId: "rasd-tools" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const isAdmin = sessionStorage.getItem('isAdmin') === 'true';
    const userEmail = sessionStorage.getItem('userEmail');
    let sysData = { lockedWeeks: [], exams: [], smartActive: false, startDate: "" };
    let pending = {};

    window.onload = async () => {
        if(!userEmail) { window.location.href="index.html"; return; }
        document.getElementById('displayUserName').innerText = sessionStorage.getItem('userName') || "Ù…Ø³ØªØ®Ø¯Ù…";
        
        // 1. Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹
        const vWeek = document.getElementById('viewWeek');
        const eWeek = document.getElementById('examWeekSelect');
        const lContainer = document.getElementById('weekLocksContainer');
        
        for(let i=1; i<=14; i++) {
            let wid = `w${i}`;
            vWeek.innerHTML += `<option value="${wid}">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${i}</option>`;
            if(isAdmin) {
                eWeek.innerHTML += `<option value="${wid}">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${i} (Ø§Ø®ØªØ¨Ø§Ø±)</option>`;
                lContainer.innerHTML += `<div class="week-item"><input type="checkbox" class="w-chk" value="${wid}" onchange="updateSettings()"> Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${i}</div>`;
            }
        }

        // 2. Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        try {
            const doc = await db.collection('settings').doc('global').get();
            if(doc.exists) {
                sysData = doc.data();
                if(isAdmin) {
                    document.getElementById('smartActive').checked = sysData.smartActive || false;
                    document.getElementById('startDate').value = sysData.startDate || "";
                    document.getElementById('examWeekSelect').value = sysData.exams[0] || "none";
                    sysData.lockedWeeks.forEach(w => {
                        let c = document.querySelector(`.w-chk[value="${w}"]`);
                        if(c) c.checked = true;
                    });
                }
            }
        } catch(e) { console.log("First time setup"); }

        // 3. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        if(isAdmin) {
            document.getElementById('adminPanel').classList.remove('hidden');
            document.getElementById('viewGrade').innerHTML = `<option value="1_general">1Ø«</option><option value="2_scientific">2Ø« Ø¹Ù„Ù…ÙŠ</option><option value="2_literary">2Ø« Ø£Ø¯Ø¨ÙŠ</option>`;
        } else {
            await loadTeacherInfo();
        }
        loadTable();
    };

    async function loadTeacherInfo() {
        const doc = await db.collection('teachers').doc(userEmail).get();
        if(doc.exists) {
            const classes = doc.data().classes || [];
            document.getElementById('viewGrade').innerHTML = classes.map(c => `<option value="${c}">${c}</option>`).join('');
        }
    }

    async function updateSettings() {
        if(!isAdmin) return;
        sysData.smartActive = document.getElementById('smartActive').checked;
        sysData.startDate = document.getElementById('startDate').value;
        sysData.exams = document.getElementById('examWeekSelect').value !== "none" ? [document.getElementById('examWeekSelect').value] : [];
        sysData.lockedWeeks = Array.from(document.querySelectorAll('.w-chk:checked')).map(c => c.value);
        
        await db.collection('settings').doc('global').set(sysData);
        loadTable();
    }

    function isAutoLocked(weekId) {
        if(!sysData.smartActive || !sysData.startDate) return false;
        const wNum = parseInt(weekId.replace('w',''));
        const diff = Math.floor((new Date() - new Date(sysData.startDate)) / (1000*60*60*24*7)) + 1;
        return wNum > diff;
    }

    async function loadTable() {
        const week = document.getElementById('viewWeek').value;
        const gradeVal = document.getElementById('viewGrade').value;
        if(!gradeVal) return;

        const isLocked = !isAdmin && (sysData.lockedWeeks.includes(week) || isAutoLocked(week));
        const isExam = sysData.exams.includes(week);
        
        document.getElementById('lockBanner').classList.toggle('hidden', !isLocked);

        // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‡ÙŠØ¯Ø±
        const header = document.getElementById('tableHeader');
        header.innerHTML = isExam ? 
            `<tr><th>Ù…</th><th style="text-align:right">Ø§Ù„Ø§Ø³Ù…</th><th colspan="3">Ø¯Ø±Ø¬Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„ (100)</th></tr>` :
            `<tr><th>Ù…</th><th style="text-align:right">Ø§Ù„Ø§Ø³Ù…</th><th>ØªÙ‚ÙŠÙŠÙ…</th><th>Ø­ØµØ©</th><th>Ø³Ù„ÙˆÙƒ</th></tr>`;

        const [g, b] = gradeVal.split('_');
        const snap = await db.collection('students').where('grade','==',g).where('branch','==',b).get();
        const students = [];
        snap.forEach(d => students.push({id: d.id, ...d.data()}));
        students.sort((a,b) => (a.sortOrder || 0) - (b.sortOrder || 0));

        const tbody = document.getElementById('mainTbody');
        tbody.innerHTML = '';
        students.forEach((s, i) => {
            let row = `<td>${i+1}</td><td style="text-align:right">${s.name}</td>`;
            if(isExam) {
                row += `<td colspan="3"><input type="number" class="in-score" style="width:150px" oninput="queue('${s.id}','ex',this,100)" data-sid="${s.id}" data-type="ex" ${isLocked ? 'disabled' : ''}></td>`;
            } else {
                row += `<td><input type="number" class="in-score" oninput="queue('${s.id}','t',this,15)" data-sid="${s.id}" data-type="t" ${isLocked ? 'disabled' : ''}></td>
                        <td><input type="number" class="in-score" oninput="queue('${s.id}','v',this,15)" data-sid="${s.id}" data-type="v" ${isLocked ? 'disabled' : ''}></td>
                        <td><input type="number" class="in-score" oninput="queue('${s.id}','s',this,10)" data-sid="${s.id}" data-type="s" ${isLocked ? 'disabled' : ''}></td>`;
            }
            tbody.innerHTML += `<tr>${row}</tr>`;
        });
        loadSavedGrades();
    }

    function queue(sid, type, input, max) {
        let v = parseFloat(input.value);
        if(v > max) { alert("ØªØ¬Ø§ÙˆØ²Øª Ø§Ù„Ø­Ø¯!"); input.value = ""; return; }
        const week = document.getElementById('viewWeek').value;
        pending[`${sid}_${week}_${type}`] = { sid, week, type, score: v, teacher: userEmail };
        input.style.borderColor = "var(--accent)";
        document.getElementById('saveBtn').innerText = `ğŸ’¾ Ø­ÙØ¸ (${Object.keys(pending).length})`;
    }

    async function saveData() {
        const batch = db.batch();
        for(let k in pending) batch.set(db.collection('grades').doc(k), pending[k], {merge:true});
        await batch.commit();
        pending = {};
        document.getElementById('saveBtn').innerText = "ğŸ’¾ Ø­ÙØ¸ (0)";
        alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ âœ…"); loadTable();
    }

    async function loadSavedGrades() {
        const week = document.getElementById('viewWeek').value;
        const snap = await db.collection('grades').where('week','==',week).get();
        snap.forEach(doc => {
            const d = doc.data();
            const input = document.querySelector(`input[data-sid="${d.sid}"][data-type="${d.type}"]`);
            if(input) { input.value = d.score; input.style.borderColor = "#ccc"; }
        });
    }

    async function importStudents() {
        const names = document.getElementById('namesInput').value.split('\n').filter(n => n.trim() !== "");
        const [g, b] = document.getElementById('viewGrade').value.split('_');
        const batch = db.batch();
        names.forEach((n, i) => batch.set(db.collection('students').doc(), { name: n.trim(), grade: g, branch: b, sortOrder: i }));
        await batch.commit(); alert("ØªÙ… Ø§Ù„Ø±ÙØ¹ âœ…"); loadTable();
    }

    async function addTeacher() {
        const id = document.getElementById('t-id').value;
        const name = document.getElementById('t-name').value;
        const classes = [document.getElementById('viewGrade').value];
        await db.collection('teachers').doc(id).set({ name, pass: "123", classes });
        alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ù„Ù… (ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© 123) âœ…");
    }

    function logout() { sessionStorage.clear(); window.location.href="index.html"; }
</script>
</body>
</html>
