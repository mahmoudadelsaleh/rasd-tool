<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>منظومة الرصد - تسجيل الدخول</title>

    <link rel="apple-touch-icon" href="icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192x192.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e293b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>

    <script src="firebase-config.js"></script>

    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #1e293b; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            height: 100vh; 
            margin: 0;
            overflow: hidden;
        }
        .login-card { 
            background: white; 
            padding: 30px; 
            border-radius: 25px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.3); 
            width: 90%; 
            max-width: 380px; 
            text-align: center;
            animation: fadeIn 0.8s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .logo-container {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: url('icon-192x192.png') no-repeat center;
            background-size: contain;
            border-radius: 15px;
        }
        h2 { color: #1e293b; margin-bottom: 5px; font-size: 22px; }
        p { color: #64748b; font-size: 14px; margin-bottom: 25px; }

        input { 
            width: 100%; 
            padding: 14px; 
            margin: 8px 0; 
            border: 2px solid #f1f5f9; 
            border-radius: 12px; 
            background: #f8fafc;
            font-size: 16px;
            outline: none;
            transition: 0.3s;
        }
        input:focus { border-color: #3b82f6; background: white; }

        button { 
            width: 100%; 
            padding: 14px; 
            background: #3b82f6; 
            color: white; 
            border: none; 
            border-radius: 12px; 
            cursor: pointer; 
            font-weight: bold; 
            font-size: 16px;
            margin-top: 15px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            transition: 0.2s;
        }
        button:active { transform: scale(0.98); background: #2563eb; }
        button:disabled { background: #94a3b8; cursor: not-allowed; }

        .error { 
            color: #e11d48; 
            font-size: 13px; 
            margin-top: 15px; 
            background: #fff1f2;
            padding: 8px;
            border-radius: 8px;
            display: none; 
        }
        .version { margin-top: 20px; font-size: 10px; color: #cbd5e1; }
    </style>
</head>
<body>

<div class="login-card">
    <div class="logo-container"></div>
    <h2>منظومة الرصد</h2>
    <p>بوابة تسجيل دخول الموظفين</p>

    <input type="text" id="user" placeholder="اسم المستخدم" autocomplete="username">
    <input type="password" id="pass" placeholder="كلمة المرور" autocomplete="current-password">

    <button id="loginBtn" onclick="handleLogin()">تسجيل الدخول</button>

    <div id="err" class="error"></div>
    <div class="version">إصدار v2026.2.1 - نظام الحماية الموحد</div>
</div>

<script>
    // تسجيل الـ Service Worker للـ PWA
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js');
        });
    }

    // تهيئة Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    async function handleLogin() {
        const u = document.getElementById('user').value.trim().toLowerCase();
        const p = document.getElementById('pass').value.trim();
        const btn = document.getElementById('loginBtn');
        const errDiv = document.getElementById('err');

        if(!u || !p) {
            showError("يرجى إدخال اسم المستخدم وكلمة المرور");
            return;
        }

        errDiv.style.display = "none";
        btn.innerText = "جاري التحقق من الصلاحيات...";
        btn.disabled = true;

        try {
            // تحويل اسم المستخدم لبريد وهمي للتعامل مع Firebase Auth
            // هذا يسمح للمدرس بالدخول باسمه فقط بينما النظام يراه حساباً مؤمناً
            const fakeEmail = u + "@rasd.com";
            
            // تسجيل الدخول الرسمي
            await auth.signInWithEmailAndPassword(fakeEmail, p);

            // إذا نجح التسجيل، نتحقق من بيانات المعلم وصلاحياته في Firestore
            const tDoc = await db.collection('teachers').doc(u).get();

            if (tDoc.exists) {
                const userData = tDoc.data();
                sessionStorage.setItem('userEmail', u);
                
                // معالجة حقل role
                const role = userData.role ? userData.role.toString().toLowerCase().trim() : 'teacher';

                if (role === 'admin') {
                    sessionStorage.setItem('isAdmin', 'true');
                    window.location.href = "admin.html";
                } else {
                    sessionStorage.setItem('isAdmin', 'false');
                    window.location.href = "teacher.html";
                }
            } else {
                // في حالة وجود الحساب في Auth ولكن ليس في Firestore
                showError("خطأ في صلاحيات الوصول");
                auth.signOut();
            }

        } catch (e) {
            console.error(e);
            let msg = "بيانات الدخول غير صحيحة";
            
            // تخصيص رسائل الخطأ بناءً على كود Firebase
            if (e.code === 'auth/user-not-found' || e.code === 'auth/wrong-password') {
                msg = "اسم المستخدم أو كلمة المرور خطأ";
            } else if (e.code === 'auth/network-request-failed') {
                msg = "فشل الاتصال.. تحقق من الإنترنت";
            } else if (e.code === 'auth/operation-not-allowed') {
                msg = "يجب تفعيل Email/Password في Firebase";
            }

            showError(msg);
        }
    }

    function showError(msg) {
        const errDiv = document.getElementById('err');
        const btn = document.getElementById('loginBtn');
        errDiv.innerText = msg;
        errDiv.style.display = "block";
        btn.innerText = "تسجيل الدخول";
        btn.disabled = false;
    }
</script>
</body>
</html>
