<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø°ÙƒÙŠØ©</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f1f5f9; margin: 0; padding-bottom: 80px; }
        header { background: white; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; justify-content: space-between; }
        .container { padding: 10px; max-width: 500px; margin: auto; }
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 5px; }
        .student-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
        .inputs { display: flex; gap: 5px; }
        .input-box { text-align: center; }
        .input-box label { font-size: 10px; display: block; }
        .score-sel { width: 60px; height: 35px; font-weight: bold; border-radius: 5px; }
        .score-sel.saved { border: 2px solid #10b981; background: #f0fdf4; }
        .bulk-bar { display: flex; gap: 5px; background: #e2e8f0; padding: 10px; border-radius: 10px; margin-bottom: 10px; align-items: center; }
        .btn-bulk { padding: 5px; font-size: 11px; cursor: pointer; }
    </style>
</head>
<body>

<header>
    <div>Ù…Ø±Ø­Ø¨Ø§Ù‹: <b id="tName">...</b></div>
    <button onclick="location.href='index.html'">Ø®Ø±ÙˆØ¬</button>
</header>

<div class="container">
    <div class="card">
        <select id="vGrade" onchange="loadList()"><option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ</option></select>
        <select id="vWeek" onchange="loadList()"></select>
    </div>

    <div id="list"></div>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyBePGZiqMPmZQdg36jZ4Rkdtd7OISxmob8", projectId: "rasd-tools" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const tId = sessionStorage.getItem('userEmail');
    let currentStudents = [];

    window.onload = async () => {
        if(!tId) location.href="index.html";
        const tDoc = await db.collection('teachers').doc(tId).get();
        if(tDoc.exists) {
            document.getElementById('tName').innerText = tDoc.data().name;
            tDoc.data().classes.forEach(c => document.getElementById('vGrade').innerHTML += `<option value="${c}">${c}</option>`);
        }
        for(let i=1; i<=14; i++) document.getElementById('vWeek').innerHTML += `<option value="w${i}">Ø£Ø³Ø¨ÙˆØ¹ ${i}</option>`;
    };

    async function loadList() {
        const gV = document.getElementById('vGrade').value;
        const wV = document.getElementById('vWeek').value;
        if(!gV || !wV) return;

        const set = await db.collection('settings').doc('global').get();
        if(set.exists && set.data().lockedWeeks.includes(wV)) {
            document.getElementById('list').innerHTML = "<h3 style='color:red; text-align:center'>Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ù…ØºÙ„Ù‚ ğŸ”’</h3>";
            return;
        }

        const [g, b] = gV.split('_');
        const sSnap = await db.collection('students').where('grade','==',g).where('branch','==',b).get();
        currentStudents = sSnap.docs.map(doc => ({id: doc.id, ...doc.data()})).sort((a,b)=>a.sortOrder-b.sortOrder);

        const gSnap = await db.collection('grades').where('teacher','==',tId).where('week','==',wV).get();
        const grades = {};
        gSnap.forEach(doc => { const d = doc.data(); if(!grades[d.sid]) grades[d.sid] = {}; grades[d.sid][d.type] = d.score; });

        let h = `
        <div class="bulk-bar">
            <span style="font-size:11px">Ø±ØµØ¯ Ù„Ù„ÙƒÙ„:</span>
            <button class="btn-bulk" onclick="bulk(15,'t')">ØªÙ‚ÙŠÙŠÙ…(15)</button>
            <button class="btn-bulk" onclick="bulk(15,'v')">Ø­ØµØ©(15)</button>
            <button class="btn-bulk" onclick="bulk(10,'s')">Ø³Ù„ÙˆÙƒ(10)</button>
        </div>`;

        currentStudents.forEach(s => {
            const sc = grades[s.id] || {};
            h += `
            <div class="card">
                <div class="student-row">
                    <span style="font-size:14px; width:50%">${s.name}</span>
                    <div class="inputs">
                        ${drawSel(s.id, 't', 15, sc.t)}
                        ${drawSel(s.id, 'v', 15, sc.v)}
                        ${drawSel(s.id, 's', 10, sc.s)}
                    </div>
                </div>
            </div>`;
        });
        document.getElementById('list').innerHTML = h;
    }

    function drawSel(sid, type, max, cur) {
        let opt = '<option value="">-</option>';
        for(let i=0; i<=max; i++) opt += `<option value="${i}" ${cur==i?'selected':''}>${i}</option>`;
        return `<div class="input-box"><label>${type=='t'?'ØªÙ‚ÙŠÙŠÙ…':type=='v'?'Ø­ØµØ©':'Ø³Ù„ÙˆÙƒ'}</label>
                <select class="score-sel ${cur!==undefined?'saved':''}" onchange="save('${sid}','${type}',this,${max})">${opt}</select></div>`;
    }

    async function save(sid, type, el, max) {
        let val = el.value;
        if(val === "") return;
        if(val > max) val = max; // ØªØµØ­ÙŠØ­ ØªÙ„Ù‚Ø§Ø¦ÙŠ
        const week = document.getElementById('vWeek').value;
        await db.collection('grades').doc(`${sid}_${week}_${type}_${tId}`).set({
            sid, type, score: parseInt(val), week, teacher: tId
        }, {merge:true});
        el.classList.add('saved');
    }

    async function bulk(score, type) {
        if(!confirm(`Ø±ØµØ¯ ${score} Ù„Ù„ÙƒÙ„ØŸ`)) return;
        const week = document.getElementById('vWeek').value;
        const batch = db.batch();
        currentStudents.forEach(s => {
            batch.set(db.collection('grades').doc(`${s.id}_${week}_${type}_${tId}`), {
                sid: s.id, type, score, week, teacher: tId
            }, {merge:true});
        });
        await batch.commit(); loadList();
    }
</script>
</body>
</html>
