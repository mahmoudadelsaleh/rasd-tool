<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø±ØµØ¯ Ø§Ù„Ø°ÙƒÙŠ v2026 - Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø·ÙˆØ±Ø©</title>

<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

<style>
:root{--primary:#3b82f6;--success:#10b981;--sidebar:#1e293b;--danger:#ef4444;--warning:#f59e0b;--gray:#64748b;}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Segoe UI',Tahoma,sans-serif;background:#f1f5f9;overscroll-behavior-y:contain;direction:rtl;}
header{background:var(--sidebar);color:white;padding:12px 15px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100;box-shadow:0 2px 10px rgba(0,0,0,0.1);}
.header-info{display:flex;align-items:center;gap:8px;}
#tName{font-weight:bold;color:white;}
.badge{background:#334155;padding:4px 10px;border-radius:20px;font-size:11px;color:#e2e8f0;}
.container{padding:12px;max-width:600px;margin:auto;padding-bottom:80px;}
.card{background:white;border-radius:14px;padding:12px;margin-bottom:10px;border:1px solid #e2e8f0;transition:all 0.2s;}
.card.active-row{border:2px solid var(--primary);background:#f0f7ff;box-shadow:0 4px 10px rgba(59,130,246,0.15);}
.student-name{font-size:14px;font-weight:600;color:#0f172a;}
.score-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px;}
.score-cell{text-align:center;}
.score-cell small{font-size:11px;color:var(--gray);display:block;margin-bottom:4px;}
.score-sel{width:100%;height:44px;font-weight:bold;text-align:center;border-radius:10px;border:1px solid #cbd5e1;background:#fff;font-size:16px;cursor:pointer;caret-color:transparent;transition:all 0.15s;box-shadow:0 1px 2px rgba(0,0,0,0.05);}
.score-sel.active-input{border:3px solid var(--primary);box-shadow:0 0 0 2px rgba(59,130,246,0.2);}
.score-sel.saved{background:#f0fdf4;border-color:#86efac;color:#166534;font-weight:bold;}
.score-sel.locked{background:#f1f5f9;border-color:#cbd5e1;color:#94a3b8;cursor:not-allowed;opacity:0.7;}
.score-sel:active{transform:scale(0.98);}
select{width:100%;padding:14px 12px;border-radius:12px;border:1px solid #cbd5e1;font-weight:500;margin-bottom:12px;background:white;font-size:15px;appearance:none;background-image:url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");background-repeat:no-repeat;background-position:left 12px center;background-size:18px;}
select:focus{outline:2px solid var(--primary);outline-offset:2px;}
.smart-keyboard{position:fixed;bottom:0;left:0;right:0;background:#1e293b;padding:12px;display:none;gap:6px;z-index:1000;border-radius:20px 20px 0 0;box-shadow:0 -5px 20px rgba(0,0,0,0.3);animation:slideUp 0.2s ease;}
@keyframes slideUp{from{transform:translateY(100%);}to{transform:translateY(0);}}
.key-btn{background:white;border-radius:10px;font-weight:bold;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;border:none;height:50px;user-select:none;box-shadow:0 2px 4px rgba(0,0,0,0.2);transition:all 0.1s;}
.key-btn:active{background:var(--primary);color:white;transform:scale(0.9);}
.key-zero{background:#475569;color:white;}
.key-zero:active{background:var(--danger);}
.key-done{background:var(--success);color:white;font-size:16px;font-weight:bold;}
.key-done:active{background:#059669;}
.kb-max-30{grid-template-columns:repeat(8,1fr);}
.kb-max-15{grid-template-columns:repeat(5,1fr);}
.kb-max-10{grid-template-columns:repeat(5,1fr);}
.sync-status{position:fixed;bottom:5px;right:10px;font-size:11px;color:white;background:rgba(0,0,0,0.5);padding:4px 12px;border-radius:30px;backdrop-filter:blur(4px);z-index:1100;}
.loading{text-align:center;padding:30px;color:var(--gray);font-size:14px;}
.loading::after{content:'';display:inline-block;width:16px;height:16px;border:2px solid #e2e8f0;border-top-color:var(--primary);border-radius:50%;animation:spin 0.8s infinite;margin-right:8px;vertical-align:middle;}
@keyframes spin{to{transform:rotate(360deg);}}
.empty-state{text-align:center;padding:40px 20px;color:var(--gray);background:white;border-radius:16px;}
.empty-state span{font-size:48px;display:block;margin-bottom:10px;}
.week-badge{display:inline-block;background:var(--primary);color:white;padding:4px 12px;border-radius:20px;font-size:12px;margin-bottom:10px;}
.stats-row{display:flex;justify-content:space-between;background:#f8fafc;padding:8px 12px;border-radius:10px;margin-bottom:15px;font-size:13px;color:var(--gray);}
</style>
</head>
<body>

<header>
<div class="header-info">
<span>ğŸ‘¨â€ğŸ«</span>
<b id="tName">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</b>
<span id="weekStatus" class="badge">-</span>
</div>
<div style="display:flex;gap:8px;">
<span id="scoresCount" style="background:#334155;padding:4px 10px;border-radius:20px;font-size:11px;">0 Ø¯Ø±Ø¬Ø§Øª</span>
<button onclick="logout()" style="background:var(--danger);color:white;border:none;padding:6px 14px;border-radius:30px;font-size:13px;font-weight:bold;cursor:pointer;">Ø®Ø±ÙˆØ¬</button>
</div>
</header>

<div class="container">
<select id="vGrade" onchange="loadStudentsData()">
<option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ...</option>
</select>

<div class="stats-row" id="weekInfo" style="display:none;">
<span>ğŸ“Š Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø§Ù„Ù…ÙØªÙˆØ­Ø©: <span id="openWeeksCount">0</span></span>
<span>ğŸ”¢ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª: <span id="limitsDisplay">-</span></span>
</div>

<select id="vWeek" onchange="loadStudentsData()"></select>

<div id="studentList" class="student-list"></div>
</div>

<div class="smart-keyboard" id="numPad"></div>
<div class="sync-status" id="syncStat">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</div>

<script>
// ==================== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ====================
const firebaseConfig = {
    apiKey: "AIzaSyBePGZiqMPmZQdg36jZ4Rkdtd7OISxmob8",
    projectId: "rasd-tools"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ø¹Ù…Ù„ Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„
db.enablePersistence({ synchronizeTabs: true })
    .catch(err => console.log('Persistence error:', err));

// ==================== Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ====================
const tId = sessionStorage.getItem("userEmail");
if(!tId) location.href = "index.html";

let currentStudents = [];
let activeInput = null;
let sysConfig = { openWeeks: [] };
let sysSettings = {
    weeksCount: 14,
    examsCount: 2,
    maxT: 15,
    maxV: 15,
    maxS: 10,
    maxExam: 30
};
let teacherData = null;
let lastTapTime = 0;
let loadingGrades = false;

// ==================== Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ====================
window.onload = async () => {
    try {
        syncStat.innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
        
        // ØªØ­Ù…Ø¨ÙŠØ¶ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
        const [configSnap, settingsSnap, tDoc] = await Promise.all([
            db.collection("system").doc("config").get(),
            db.collection("system").doc("settings").get(),
            db.collection("teachers").doc(tId).get()
        ]);

        // ØªØ­Ù…Ø¨ÙŠØ¶ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù‚ÙØ§Ù„
        if(configSnap.exists) sysConfig = configSnap.data();
        
        // ØªØ­Ù…Ø¨ÙŠØ¶ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¯Ø±Ø¬Ø§Øª
        if(settingsSnap.exists) sysSettings = settingsSnap.data();
        
        // ØªØ­Ù…Ø¨ÙŠØ¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…
        if(!tDoc.exists) {
            alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©");
            logout();
            return;
        }
        
        teacherData = tDoc.data();
        document.getElementById('tName').innerText = teacherData.name || 'Ù…Ø¹Ù„Ù…';
        
        // ØªØ¹Ø¨Ø¦Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØµÙÙˆÙ
        const gradeSelect = document.getElementById('vGrade');
        if(teacherData.classes && teacherData.classes.length) {
            teacherData.classes.forEach(c => {
                const option = document.createElement('option');
                option.value = c;
                option.textContent = c === '1_general' ? 'Ø£ÙˆÙ„Ù‰ Ø«Ø§Ù†ÙˆÙŠ' :
                                    c === '2_scientific' ? 'Ø«Ø§Ù†ÙŠØ© Ø¹Ù„Ù…ÙŠ' : 'Ø«Ø§Ù†ÙŠØ© Ø£Ø¯Ø¨ÙŠ';
                gradeSelect.appendChild(option);
            });
        }
        
        // ØªØ¹Ø¨Ø¦Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹
        renderWeeksSelect();
        
        // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø¯ÙˆØ¯
        updateLimitsDisplay();
        
        syncStat.innerText = "âœ… Ù…ØªØµÙ„";
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØµÙ Ù…Ø­Ø¯Ø¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹ØŒ Ø­Ù…Ù‘Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if(gradeSelect.value) loadStudentsData();
        
    } catch (error) {
        console.error(error);
        syncStat.innerText = "âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„";
    }
};

// ==================== ØªÙˆÙ„ÙŠØ¯ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ ====================
function renderWeeksSelect() {
    const weekSelect = document.getElementById('vWeek');
    weekSelect.innerHTML = '';
    
    // Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
    for(let i = 1; i <= sysSettings.weeksCount; i++) {
        const option = document.createElement('option');
        option.value = `w${i}`;
        
        // ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ (Ù…ÙØªÙˆØ­/Ù…ØºÙ„Ù‚)
        if(sysConfig.openWeeks && sysConfig.openWeeks.includes(`w${i}`)) {
            option.textContent = `ğŸ“… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${i} (Ù…ÙØªÙˆØ­)`;
            option.style.fontWeight = 'bold';
            option.style.color = '#10b981';
        } else {
            option.textContent = `ğŸ”’ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${i} (Ù…ØºÙ„Ù‚)`;
            option.style.color = '#94a3b8';
        }
        weekSelect.appendChild(option);
    }
    
    // Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
    for(let i = 1; i <= sysSettings.examsCount; i++) {
        const option = document.createElement('option');
        option.value = `ex${i}`;
        option.textContent = `ğŸ“ Ø§Ø®ØªØ¨Ø§Ø± ${i}`;
        option.style.fontWeight = 'bold';
        option.style.color = '#8b5cf6';
        weekSelect.appendChild(option);
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø§Ù„Ù…ÙØªÙˆØ­Ø©
    if(sysConfig.openWeeks) {
        document.getElementById('openWeeksCount').innerText = sysConfig.openWeeks.length;
    }
    document.getElementById('weekInfo').style.display = 'flex';
}

// ==================== ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ====================
function updateLimitsDisplay() {
    document.getElementById('limitsDisplay').innerHTML = 
        `Øª:${sysSettings.maxT} Ùˆ:${sysSettings.maxV} Ø³:${sysSettings.maxS} Ø§Ø®:${sysSettings.maxExam}`;
}

// ==================== ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ ====================
async function loadStudentsData() {
    const gV = document.getElementById('vGrade').value;
    const wV = document.getElementById('vWeek').value;
    
    if(!gV || !wV) {
        document.getElementById('studentList').innerHTML = `
            <div class="empty-state">
                <span>ğŸ‘ˆ</span>
                <p>Ø§Ø®ØªØ± Ø§Ù„ØµÙ ÙˆØ§Ù„Ø£Ø³Ø¨ÙˆØ¹</p>
            </div>`;
        return;
    }
    
    document.getElementById('studentList').innerHTML = '<div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨...</div>';
    
    try {
        const [g, b] = gV.split("_");
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨
        const sSnap = await db.collection("students")
            .where("grade", "==", g)
            .where("branch", "==", b)
            .orderBy("sortOrder", "asc")
            .get();
        
        currentStudents = sSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹
        const gradesSnap = await db.collection("grades")
            .where("teacher", "==", tId)
            .where("week", "==", wV)
            .get();
        
        const savedGrades = {};
        gradesSnap.docs.forEach(doc => {
            const data = doc.data();
            savedGrades[`${data.sid}_${data.type}`] = data.score;
        });
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        renderStudentList(savedGrades, wV);
        
        // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª
        document.getElementById('scoresCount').innerText = `${gradesSnap.size} Ø¯Ø±Ø¬Ø§Øª`;
        
    } catch (error) {
        console.error(error);
        document.getElementById('studentList').innerHTML = `
            <div class="empty-state">
                <span>âŒ</span>
                <p>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</p>
            </div>`;
    }
}

// ==================== Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ====================
function renderStudentList(savedGrades = {}, week) {
    if(currentStudents.length === 0) {
        document.getElementById('studentList').innerHTML = `
            <div class="empty-state">
                <span>ğŸ“­</span>
                <p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØµÙ</p>
            </div>`;
        return;
    }
    
    let html = '';
    
    // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹
    const isWeekOpen = week.startsWith('ex') || (sysConfig.openWeeks && sysConfig.openWeeks.includes(week));
    
    html += `<div class="week-badge" style="background:${isWeekOpen ? '#10b981' : '#ef4444'}">
        ${isWeekOpen ? 'âœ“ Ø£Ø³Ø¨ÙˆØ¹ Ù…ÙØªÙˆØ­' : 'ğŸ”’ Ø£Ø³Ø¨ÙˆØ¹ Ù…ØºÙ„Ù‚'}
    </div>`;
    
    currentStudents.forEach((s, i) => {
        const tScore = savedGrades[`${s.id}_t`] || '';
        const vScore = savedGrades[`${s.id}_v`] || '';
        const sScore = savedGrades[`${s.id}_s`] || '';
        const examScore = savedGrades[`${s.id}_exam`] || '';
        
        html += `<div class="card" id="row_${s.id}">
            <div style="margin-bottom:8px;">
                <span class="student-name">${String(i+1).padStart(2,'0')}. ${s.name}</span>
            </div>
            <div class="score-grid">
                <div class="score-cell">
                    <small>ğŸ“‹ ØªÙ‚ÙŠÙŠÙ…</small>
                    <input readonly class="score-sel ${tScore ? 'saved' : ''} ${!isWeekOpen && !week.startsWith('ex') ? 'locked' : ''}" 
                        id="inp_${s.id}_t" value="${tScore}"
                        onclick="${isWeekOpen || week.startsWith('ex') ? `openPad('${s.id}','t',${sysSettings.maxT})` : ''}">
                </div>
                <div class="score-cell">
                    <small>ğŸ“š ÙˆØ§Ø¬Ø¨</small>
                    <input readonly class="score-sel ${vScore ? 'saved' : ''} ${!isWeekOpen && !week.startsWith('ex') ? 'locked' : ''}" 
                        id="inp_${s.id}_v" value="${vScore}"
                        onclick="${isWeekOpen || week.startsWith('ex') ? `openPad('${s.id}','v',${sysSettings.maxV})` : ''}">
                </div>
                <div class="score-cell">
                    <small>ğŸ¤ Ø³Ù„ÙˆÙƒ</small>
                    <input readonly class="score-sel ${sScore ? 'saved' : ''} ${!isWeekOpen && !week.startsWith('ex') ? 'locked' : ''}" 
                        id="inp_${s.id}_s" value="${sScore}"
                        onclick="${isWeekOpen || week.startsWith('ex') ? `openPad('${s.id}','s',${sysSettings.maxS})` : ''}">
                </div>
                <div class="score-cell">
                    <small>âœï¸ Ø§Ø®ØªØ¨Ø§Ø±</small>
                    <input readonly class="score-sel ${examScore ? 'saved' : ''}" 
                        id="inp_${s.id}_exam" value="${examScore}"
                        onclick="openPad('${s.id}','exam',${sysSettings.maxExam})">
                </div>
            </div>
        </div>`;
    });
    
    document.getElementById('studentList').innerHTML = html;
}

// ==================== ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ====================
function openPad(sid, type, max) {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ù…ÙØªÙˆØ­ (Ù„Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© ÙÙ‚Ø·)
    const week = document.getElementById('vWeek').value;
    
    if(!week.startsWith('ex')) {
        if(!sysConfig.openWeeks || !sysConfig.openWeeks.includes(week)) {
            alert('âŒ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ù…ØºÙ„Ù‚ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©');
            return;
        }
    }
    
    activeInput = { sid, type, max };
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚
    document.querySelectorAll('.card').forEach(c => c.classList.remove('active-row'));
    document.getElementById(`row_${sid}`).classList.add('active-row');
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
    const pad = document.getElementById('numPad');
    pad.style.display = "grid";
    
    // Ø§Ø®ØªÙŠØ§Ø± Ù†Ù…Ø· Ø§Ù„Ù„ÙˆØ­Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰
    if(max > 20) {
        pad.className = "smart-keyboard kb-max-30";
    } else if(max > 10) {
        pad.className = "smart-keyboard kb-max-15";
    } else {
        pad.className = "smart-keyboard kb-max-10";
    }
    
    // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    let keys = "";
    
    // Ù„Ù„Ø£Ø±Ù‚Ø§Ù… Ø­ØªÙ‰ 30
    if(max > 20) {
        for(let i = 1; i <= max; i++) {
            keys += `<div class="key-btn" onclick="inputValue(${i})">${i}</div>`;
        }
    } 
    // Ù„Ù„Ø£Ø±Ù‚Ø§Ù… Ø­ØªÙ‰ 15
    else if(max > 10) {
        for(let i = 1; i <= max; i++) {
            keys += `<div class="key-btn" onclick="inputValue(${i})">${i}</div>`;
        }
    }
    // Ù„Ù„Ø£Ø±Ù‚Ø§Ù… Ø­ØªÙ‰ 10
    else {
        for(let i = 1; i <= max; i++) {
            keys += `<div class="key-btn" onclick="inputValue(${i})">${i}</div>`;
        }
    }
    
    // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„ØµÙØ± ÙˆØ²Ø± ØªÙ…
    keys += `<div class="key-btn key-zero" onclick="inputValue(0)">0</div>`;
    keys += `<div class="key-btn key-done" style="grid-column:span 2" onclick="closePad()">âœ“ ØªÙ…</div>`;
    
    pad.innerHTML = keys;
    
    // Ø§Ù‡ØªØ²Ø§Ø² Ø®ÙÙŠÙ
    if(navigator.vibrate) navigator.vibrate(10);
}

// ==================== Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù‚ÙŠÙ…Ø© ====================
function inputValue(val) {
    if(!activeInput) return;
    
    // Ù…Ù†Ø¹ Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬ Ø§Ù„Ø³Ø±ÙŠØ¹
    const now = Date.now();
    if(now - lastTapTime < 150) return;
    lastTapTime = now;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¶Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­
    if(val > activeInput.max) {
        alert(`Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚ØµÙˆÙ‰ ${activeInput.max}`);
        return;
    }
    
    // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
    const inp = document.getElementById(`inp_${activeInput.sid}_${activeInput.type}`);
    inp.value = val;
    inp.classList.add('saved');
    
    // ØªØ£Ø«ÙŠØ± Ù„Ù…Ø³ÙŠ
    if(navigator.vibrate) navigator.vibrate(15);
    
    // Ø­ÙØ¸ ÙÙŠ Firebase
    saveToFirebase(activeInput.sid, 
                   document.getElementById('vWeek').value, 
                   activeInput.type, 
                   val);
}

// ==================== Ø§Ù„Ø­ÙØ¸ ÙÙŠ Firebase ====================
async function saveToFirebase(sid, week, type, score) {
    try {
        const docId = `${sid}_${week}_${type}_${tId}`;
        
        await db.collection("grades").doc(docId).set({
            sid,
            week,
            type,
            score: parseInt(score),
            teacher: tId,
            timestamp: Date.now(),
            grade: document.getElementById('vGrade').value.split('_')[0]
        }, { merge: true });
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
        syncStat.innerText = "âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸";
        
        // ØªØ£Ø«ÙŠØ± Ø¨Ø³ÙŠØ·
        const inp = document.getElementById(`inp_${sid}_${type}`);
        inp.style.backgroundColor = "#d1fae5";
        setTimeout(() => inp.style.backgroundColor = "", 200);
        
        // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª
        const weekSelect = document.getElementById('vWeek').value;
        const gradesSnap = await db.collection("grades")
            .where("teacher", "==", tId)
            .where("week", "==", weekSelect)
            .get();
        document.getElementById('scoresCount').innerText = `${gradesSnap.size} Ø¯Ø±Ø¬Ø§Øª`;
        
    } catch (error) {
        console.error('Save error:', error);
        syncStat.innerText = "âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸";
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª');
    }
}

// ==================== Ø¥ØºÙ„Ø§Ù‚ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ====================
function closePad() {
    document.getElementById('numPad').style.display = "none";
    document.querySelectorAll('.card').forEach(c => c.classList.remove('active-row'));
    activeInput = null;
}

// ==================== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ====================
function logout() {
    sessionStorage.clear();
    location.href = "index.html";
}

// ==================== ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ© (Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©) ====================
setInterval(() => {
    if(document.getElementById('vGrade').value && document.getElementById('vWeek').value) {
        loadStudentsData();
    }
}, 30000);

</script>
</body>
</html>